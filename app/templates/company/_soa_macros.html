{# Soft-commonization macros for Statement of Accounts index view.
   UI and markup mirror existing templates; only logic is centralized. #}

{% from 'company/_layout_helpers.html' import render_difference %}

{# 共通サイドバー: navigation_state から内訳書グループを描画し、なければ既存リストにフォールバック #}
{% macro render_soa_sidebar(current_page, navigation_state=None) -%}
  {% set groups = navigation_state or [] %}
  {% set soa_group = none %}
  {% for group in groups %}
    {% if group.key == 'statement_of_accounts_group' %}
      {% set soa_group = group %}
    {% endif %}
  {% endfor %}
  <h3 class="sidebar-title">勘定科目内訳書</h3>
  <ul class="sidebar-menu">
    {% if soa_group %}
      {% for child in soa_group.children %}
        {% set is_active = child.is_active or child.key == current_page or (child.params and child.params.page == current_page) %}
        <li>
          <a href="{{ child.url }}" class="sidebar-link {% if is_active %}active{% endif %}">
            {{ child.name }}
          </a>
        </li>
      {% endfor %}
    {% else %}
      {% set fallback_pages = [
        ('deposits', '預貯金等'), ('notes_receivable', '受取手形'), ('accounts_receivable', '売掛金（未収入金）'),
        ('temporary_payments', '仮払金（前渡金）'), ('loans_receivable', '貸付金・受取利息'), ('inventories', '棚卸資産'),
        ('securities', '有価証券'), ('fixed_assets', '固定資産（土地等）'), ('notes_payable', '支払手形'),
        ('accounts_payable', '買掛金（未払金・未払費用）'), ('temporary_receipts', '仮受金（前受金・預り金）'), ('borrowings', '借入金及び支払利子'),
        ('executive_compensations', '役員給与等'), ('land_rents', '地代家賃等'), ('misc_income', '雑収入'), ('misc_losses', '雑損失')
      ] %}
      {% for page_id, page_name in fallback_pages %}
        <li>
          <a href="{{ url_for('company.statement_of_accounts', page=page_id) }}" class="sidebar-link {% if page_id == current_page %}active{% endif %}">
            {{ page_name }}
          </a>
        </li>
      {% endfor %}
    {% endif %}
  </ul>
{%- endmacro %}

{% macro header_actions(page, difference, next_url, empty_state, cta_config) -%}
  {% if difference is not none and (difference | default(0)) == 0 and next_url %}
    <a href="{{ next_url }}" class="button-primary">次の内訳へ</a>
  {% else %}
    <a href="{{ url_for('company.add_item', page_key=page) }}" class="{{ cta_config.header_class }}">{{ cta_config.header_label }}</a>
  {% endif %}
{%- endmacro %}

{% macro empty_state(page_title, page, empty_state) -%}
  <div class="empty-state-card">
    <h2>{{ empty_state.headline or ('まだ' ~ page_title ~ 'が登録されていません') }}</h2>
    {% if empty_state.description %}
      <p>{{ empty_state.description }}</p>
    {% endif %}
    <a href="{{ url_for('company.add_item', page_key=page) }}" class="button-primary">{{ empty_state.action_label or ('最初の' ~ page_title ~ 'を登録する') }}</a>
  </div>
{%- endmacro %}


{# Generic summary card (three rows) with difference highlighting #}
{% macro summary_generic(label, bs_total, breakdown_total, difference) -%}
<div class="card summary-card">
  <div class="summary-item">
    <span class="summary-label">{{ label }}</span>
    <span class="summary-value">{{ (bs_total | default(0)) | format_currency }}</span>
  </div>
  <div class="summary-item">
    <span class="summary-label">内訳明細の合計額</span>
    <span class="summary-value">{{ (breakdown_total | default(0)) | format_currency }}</span>
  </div>
  <div class="summary-item result {% if (difference | default(0)) == 0 %}zero{% else %}non-zero{% endif %}">
    <span class="summary-label">差額</span>
    <span class="summary-value">{{ render_difference(difference) }}</span>
  </div>
</div>
{%- endmacro %}

{# Borrowings-specific summary card #}
{% macro summary_borrowings(bs_total, pl_interest_total, breakdown_total, difference) -%}
<div class="card summary-card">
  <div class="summary-item">
    <span class="summary-label">B/S上の借入金残高</span>
    <span class="summary-value">{{ (bs_total | default(0)) | format_currency }}</span>
  </div>
  <div class="summary-item">
    <span class="summary-label">P/L上の支払利子</span>
    <span class="summary-value">{{ (pl_interest_total | default(0)) | format_currency }}</span>
  </div>
  <div class="summary-item">
    <span class="summary-label">内訳明細の合計額（期末現在高＋期間中の支払利子）</span>
    <span class="summary-value">{{ (breakdown_total | default(0)) | format_currency }}</span>
  </div>
  <div class="summary-item result {% if (difference | default(0)) == 0 %}zero{% else %}non-zero{% endif %}">
    <span class="summary-label">差額</span>
    <span class="summary-value">{{ render_difference(difference) }}</span>
  </div>
</div>
{%- endmacro %}
