{% extends "base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/data_mapping.css') }}">
{% endblock %}

{% block sidebar %}
    {% include 'company/_wizard_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ title }}</h1>
    <p>
        アップロードされた一部の勘定科目がマスターデータに存在しませんでした。<br>
        AIが最も可能性の高い候補を自動選択しています。内容を確認し、必要であれば修正してください。
    </p>
</div>

<div class="card">
    <form method="POST" action="{{ url_for('company.data_mapping') }}" novalidate>
        {{ form.hidden_tag() }}

        <table class="mapping-table">
            <thead>
                <tr>
                    <th>あなたのファイルの勘定科目</th>
                    <th>アプリの項目に紐付け（検索できます）</th>
                </tr>
            </thead>
            <tbody>
                {% for item in mapping_items %}
                <tr x-data="{ searchTerm: '' }">
                    <td>{{ item.original_name }}</td>
                    <td>
                        <div class="searchable-select">
                            <input 
                                type="text" 
                                x-model="searchTerm" 
                                @input="$refs.select.size = 5"
                                @blur="setTimeout(() => { $refs.select.size = 1 }, 150)"
                                @keydown.enter.prevent
                                placeholder="勘定科目を検索..." 
                                class="form-input search-input">

                            <select 
                                name="map_{{ item.original_name }}" 
                                x-ref="select"
                                class="form-control" 
                                required>
                                <option value="">選択してください...</option>
                                {% for master in master_accounts %}
                                <option
                                    :hidden="searchTerm && !'{{ master.name.lower() }}'.includes(searchTerm.toLowerCase())"
                                    value="{{ master.id }}" {% if master.id == item.suggested_master_id %}selected{% endif %}>
                                    {{ master.name }}
                                    {% if master.minor_category %} ＜ {{ master.minor_category }}{% endif %}
                                    {% if master.middle_category %} ＜ {{ master.middle_category }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="form-actions">
            {{ form.submit(class="button-primary") }}
        </div>
    </form>
</div>
{% endblock %}
