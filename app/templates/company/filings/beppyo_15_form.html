{% extends 'base.html' %}
{% from 'company/_form_helpers.html' import render_field %}
{% from 'company/_form_macros.html' import soa_form_card %}

{% block title %}{{ form_title }} - 別表15{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/statement_of_accounts.css') }}">
{% endblock %}

{% block content %}
  {% call soa_form_card(form, title=form_title, cancel_url=url_for('company.filings', page='beppyo_15'), cancel_label='一覧へ戻る') %}
    <div class="form-grid-2col">
      {{ render_field(form.subject, autofocus=True) }}
      {{ render_field(form.expense_amount, id='beppyo15-expense-amount', type='number', placeholder=field_definitions[1].placeholder if field_definitions else None) }}
      {{ render_field(form.deductible_amount, id='beppyo15-deductible-amount', type='number', placeholder=field_definitions[2].placeholder if field_definitions else None) }}
      <div class="form-field-spanning">
        {{ render_field(form.net_amount_display_field, id='beppyo15-net-amount', readonly=True, value=form.net_amount_display | money) }}
      </div>
      <div class="form-field-spanning">
        {{ render_field(form.hospitality_amount, id='beppyo15-hospitality-amount', type='number', placeholder=field_definitions[4].placeholder if field_definitions else None) }}
      </div>
      <div class="form-field-spanning">
        {{ render_field(form.remarks, placeholder='必要に応じてメモを残せます（任意）') }}
      </div>
    </div>
  {% endcall %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var expenseInput = document.getElementById('beppyo15-expense-amount');
      var deductibleInput = document.getElementById('beppyo15-deductible-amount');
      var netInput = document.getElementById('beppyo15-net-amount');
      if (!expenseInput || !deductibleInput || !netInput) {
        return;
      }

      var parseValue = function (input) {
        if (!input) return 0;
        var raw = (input.value || '').replace(/,/g, '').trim();
        if (!raw) return 0;
        var num = Number(raw);
        return isNaN(num) ? 0 : num;
      };

      var formatValue = function (num) {
        return Number(num || 0).toLocaleString('ja-JP');
      };

      var updateNetAmount = function () {
        var expense = parseValue(expenseInput);
        var deductible = parseValue(deductibleInput);
        var computed = Math.max(expense - deductible, 0);
        netInput.value = formatValue(computed);
      };

      ['input', 'change', 'blur'].forEach(function (eventName) {
        expenseInput.addEventListener(eventName, updateNetAmount);
        deductibleInput.addEventListener(eventName, updateNetAmount);
      });

      updateNetAmount();
    });
  </script>
{% endblock %}
