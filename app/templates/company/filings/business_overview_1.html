{% extends 'base.html' %}
{% import 'company/_bo_grid_macros.html' as bo %}

{% block title %}事業概況説明書１{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/filings_business_overview.css') }}">
{% endblock %}

{% block content %}
<h1 class="content-title">事業概況説明書１</h1>
<p class="content-subtitle">支店・子会社の状況（入力のみ・保存は未対応）</p>

<div class="bo-split-pane">
  <div class="bo-pane-left">
    <div class="card">
      <form method="get" novalidate>
        <fieldset>
          <legend>支店の状況</legend>
          {% call bo.grid(2) %}
            {{ bo.field('国内支店（国内に所在する支店等の総数）', type='number', placeholder='例：3') }}
            {{ bo.spacer() }}
            {{ bo.field('海外支店（海外に所在する支店等の総数）', type='number', placeholder='例：1', classes='bo-col-1') }}
            {{ bo.spacer() }}

            {{ bo.field('海外支店の所在地国１', type='text', placeholder='例：米国カリフォルニア州…') }}
            {{ bo.field('所在地国１の従業員数', type='number', placeholder='例：30') }}
            {{ bo.field('海外支店の所在地国２', type='text', placeholder='例：シンガポール') }}
            {{ bo.field('所在地国２の従業員数', type='number', placeholder='例：20') }}
          {% endcall %}
        </fieldset>

        <fieldset>
          <legend>子会社の状況</legend>
          {% call bo.grid(2) %}
            {{ bo.field('国内子会社の数', type='number', placeholder='例：2') }}
            {{ bo.spacer() }}
            {{ bo.field('海外子会社の数', type='number', placeholder='例：1', classes='bo-col-1') }}
            {{ bo.field('うち出資割合が50％以上の海外子会社数', type='number', placeholder='例：1') }}

            {{ bo.field('海外子会社１の名称', type='text', placeholder='例：〇〇インターナショナル株式会社') }}
            {{ bo.field('海外子会社１の出資割合', type='number', placeholder='例：60') }}

            {{ bo.field('海外子会社２の名称', type='text', placeholder='例：△△テクノロジーズ株式会社') }}
            {{ bo.field('海外子会社２の出資割合', type='number', placeholder='例：40') }}
          {% endcall %}
        </fieldset>

        <fieldset>
          <legend>海外取引状況</legend>
          <!-- Overseas Trade: row1 (radio, span all) -->
          {% call bo.grid(2) %}
            {{ bo.segmented('海外取引の種類', 'trade_type', 'radio',
              options=[('import','輸入'), ('export','輸出'), ('both','輸出入'), ('none','無')],
              span_all=True, container_id='trade_type_group') }}
          {% endcall %}

          <!-- Overseas Trade: rows 2-3 (3-col) -->
          {% call bo.grid(3, 'bo-grid-3col bo-cols-3') %}
            {{ bo.field('輸出相手国', type='text', placeholder='例：米国') }}
            {{ bo.field('主な商品', type='text', placeholder='例：電子機器') }}
            {{ bo.field('取引金額（百万円）', type='number', placeholder='例：200') }}

            {{ bo.field('輸入相手国', type='text', placeholder='例：中国') }}
            {{ bo.field('主な商品', type='text', placeholder='例：電子部品') }}
            {{ bo.field('取引金額（百万円）', type='number', placeholder='例：120') }}
          {% endcall %}

          <!-- Overseas Trade: rows 4-6 (checkbox + text, span all) -->
          {% call bo.grid(2) %}
            {{ bo.segmented('輸出入以外の海外取引（複数選択可）', 'trade_type_other', 'checkbox',
              options=[('securities','証券の売買'), ('loan','金銭の貸借'), ('realestate','不動産の売買')],
              span_all=True, container_id='trade_type_other_row1', id_prefix='trade_other') }}

            {{ bo.segmented('', 'trade_type_other', 'checkbox',
              options=[('fee','手数料'), ('royalty','ロイヤルティー'), ('services','役務の提供')],
              span_all=True, container_id='trade_type_other_row2', id_prefix='trade_other') }}

            {{ bo.field('その他', type='text',
              placeholder='輸出入以外の海外取引で上記に該当がない場合に入力してください',
              classes='bo-span-all') }}
          {% endcall %}        </fieldset>

        <fieldset>
          <legend>期末従事員等の状況</legend>

          {# 職種（6カラム・名称は後で指示） #}
          {% call bo.grid(6, 'bo-cols-6') %}
            <div class="form-group bo-span-all"><label class="form-label">期末従事員の状況</label></div>
            <div class="form-group bo-cell-center">
              <div class="bo-input-frame" role="text" aria-readonly="true">常勤役員</div>
            </div>
            <div class="form-group">
              <select class="form-control">
                <option value="" selected>選択</option>
                <option>非常勤役員</option>
                <option>工員</option>
                <option>事務員</option>
                <option>技術者</option>
                <option>販売員</option>
                <option>労務者</option>
                <option>料理人</option>
                <option>ホステス</option>
                <option>その他</option>
              </select>
            </div>
            <div class="form-group">
              <select class="form-control">
                <option value="" selected>選択</option>
                <option>非常勤役員</option>
                <option>工員</option>
                <option>事務員</option>
                <option>技術者</option>
                <option>販売員</option>
                <option>労務者</option>
                <option>料理人</option>
                <option>ホステス</option>
                <option>その他</option>
              </select>
            </div>
            <div class="form-group">
              <select class="form-control">
                <option value="" selected>選択</option>
                <option>非常勤役員</option>
                <option>工員</option>
                <option>事務員</option>
                <option>技術者</option>
                <option>販売員</option>
                <option>労務者</option>
                <option>料理人</option>
                <option>ホステス</option>
                <option>その他</option>
              </select>
            </div>
            <div class="form-group">
              <select class="form-control">
                <option value="" selected>選択</option>
                <option>非常勤役員</option>
                <option>工員</option>
                <option>事務員</option>
                <option>技術者</option>
                <option>販売員</option>
                <option>労務者</option>
                <option>料理人</option>
                <option>ホステス</option>
                <option>その他</option>
              </select>
            </div>
            <div class="form-group bo-cell-center">
              <div class="bo-input-frame" role="text" aria-readonly="true">合計</div>
            </div>
          {% endcall %}

          {% call bo.grid(6, 'bo-cols-6 js-workers-count') %}
            {{ bo.field(type='number', placeholder='例：10') }}
            {{ bo.field(type='number', placeholder='例：5') }}
            {{ bo.field(type='number', placeholder='例：8') }}
            {{ bo.field(type='number', placeholder='例：2') }}
            {{ bo.field(type='number', placeholder='例：1') }}
            <div class="form-group">
              <div class="bo-input-frame js-total" role="text" aria-live="polite" style="text-align:center;">0</div>
            </div>
          {% endcall %}

          {# 合計の内訳（2カラム） #}
          {% call bo.grid(2) %}
            {{ bo.field('合計のうち代表者家族数', type='number', placeholder='例：1') }}
            {{ bo.field('合計のうちアルバイト数', type='number', placeholder='例：3') }}
          {% endcall %}

          {# 賃金の決め方（ラジオ） #}
          {% call bo.grid(2) %}
            {{ bo.segmented('賃金の定め方', 'wage_policy', 'radio',
              options=[('A','A固定給'), ('B','B歩合給'), ('AB','AB併用')],
              span_all=True, container_id='wage_policy_group', id_prefix='wage_policy') }}
          {% endcall %}

          {# 社宅の有無（ラジオ） #}
          {% call bo.grid(2) %}
            {{ bo.segmented('社宅・寮の有無', 'company_housing', 'radio',
              options=[('yes','有'), ('no','無')],
              span_all=True, container_id='company_housing_group', id_prefix='company_housing') }}
          {% endcall %}
        </fieldset>

      </form>
    </div>
  </div>

  <div class="bo-aside-spacer" aria-hidden="true"></div>

  <aside class="bo-pane-right">
    <div class="bo-preview-card">
      <div class="bo-preview-box" style="padding:0;">
        <iframe src="{{ url_for('company.filings_preview', page='business_overview_1') }}#toolbar=0&navpanes=0&view=FitH" title="PDFプレビュー" style="width:100%; height:100%; border:0; border-radius:8px; background:#fff;"></iframe>
      </div>
      <p class="bo-preview-note">PDFの実ファイルを表示中（読み取り専用）。入力との連動は今後の段階で実装します。</p>
    </div>
  </aside>
</div>
{% endblock %}

{% block scripts %}
  {{ super() if super }}
  <script>
    (function(){
      var radios = document.querySelectorAll('input[type="radio"][name="trade_type"]');
      radios.forEach(function(el){
        el.addEventListener('mousedown', function(){ this._wasChecked = this.checked; });
        el.addEventListener('click', function(){ if (this._wasChecked) { this.checked = false; } });
      });
    })();
    (function(){
      var checks = document.querySelectorAll('input[type="checkbox"][name="trade_type_other"]');
      function syncOne(el){
        var lab = document.querySelector('label[for="'+el.id+'"]');
        if(lab){ lab.classList.toggle('is-checked', el.checked); }
      }
      checks.forEach(function(el){
        el.addEventListener('change', function(){ syncOne(el); });
        syncOne(el);
      });
      var labels = document.querySelectorAll('label[for^="trade_other_"]');
      labels.forEach(function(lab){
        lab.addEventListener('click', function(e){
          e.preventDefault();
          var id = this.getAttribute('for');
          var el = document.getElementById(id);
          if(!el) return;
          el.checked = !el.checked;
          el.dispatchEvent(new Event('change', {bubbles:true}));
        });
      });
    })();
  </script>
  <script>
    (function(){
      var split = document.querySelector('.bo-split-pane');
      var aside = document.querySelector('.bo-pane-right');
      var left  = document.querySelector('.bo-pane-left');
      var leftCard = document.querySelector('.bo-pane-left .card');
      if(!split || !aside || !left || !leftCard) return;

      var headerH = 56;
      try {
        var cssH = getComputedStyle(document.documentElement).getPropertyValue('--header-height');
        if(cssH) { var n = parseInt(cssH, 10); if(!isNaN(n)) headerH = n; }
      } catch(e){}
      var topOffset = headerH + 16;

      var gutterBase = null;
      var wasFixed = false;

      function computeGutter(splitRect, asideRect){
        return Math.round((splitRect.left + splitRect.width) - (asideRect.left + asideRect.width));
      }
      function computeLeftForFixed(splitRect, asideWidth){
        var pageX = window.pageXOffset || document.documentElement.scrollLeft || 0;
        var gutter = (gutterBase == null ? 0 : gutterBase);
        return Math.round(splitRect.left + pageX + split.clientWidth - asideWidth - gutter);
      }

      function tick(){
        var splitRect = split.getBoundingClientRect();
        var asideRect = aside.getBoundingClientRect();
        var w = asideRect.width;
        var start = leftCard.getBoundingClientRect().top + window.pageYOffset;
        var sc = window.pageYOffset + topOffset;

        if(!wasFixed){
          gutterBase = computeGutter(splitRect, asideRect);
        }
        if(sc >= start){
          aside.style.position = 'fixed';
          aside.style.top = topOffset + 'px';
          aside.style.width = w + 'px';
          aside.style.left = computeLeftForFixed(splitRect, w) + 'px';
          left.style.paddingRight = (w + 24) + 'px';
          wasFixed = true;
        } else {
          aside.style.position = '';
          aside.style.top = '';
          aside.style.left = '';
          aside.style.width = '';
          left.style.paddingRight = '';
          wasFixed = false;
        }
      }
      window.addEventListener('scroll', tick, {passive:true});
      window.addEventListener('resize', function(){
        var was = wasFixed;
        aside.style.position = '';
        aside.style.left = '';
        wasFixed = false;
        tick();
        if(was){ tick(); }
      });
      tick();
    })();
  </script>
  <script>
    (function(){
      var container = document.querySelector('.js-workers-count');
      if(!container) return;
      var nums = Array.prototype.slice.call(container.querySelectorAll('input.form-control[type="number"]'));
      if(nums.length < 2) return;
      var totalInput = container.querySelector('input.js-total');
      var totalDisplay = container.querySelector('.js-total');
      var total = totalInput || totalDisplay || nums[nums.length - 1];
      if(!total) return;
      if(total.tagName === 'INPUT'){
        total.readOnly = true;
        total.setAttribute('aria-readonly', 'true');
      }
      function toNumber(el){
        var v = (el.value || '').replace(/,/g,'').trim();
        if(v === '') return 0;
        var n = Number(v);
        return isFinite(n) ? n : 0;
      }
      function recalc(){
        var sum = 0;
        for(var i=0;i<nums.length;i++){
          var el = nums[i];
          if(el === total) continue;
          sum += toNumber(el);
        }
        if(total.tagName === 'INPUT'){
          if(String(sum) !== total.value){ total.value = String(sum); }
        } else {
          total.textContent = String(sum);
        }
      }
      nums.forEach(function(el){ if(el !== total){ el.addEventListener('input', recalc); }});
      recalc();
    })();
  </script>
{% endblock %}