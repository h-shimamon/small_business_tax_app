{% extends 'base.html' %}
{% import 'company/_bo_grid_macros.html' as bo %}
{# Options constants for this page only (to avoid duplication) #}
{% set OPTIONS_STAFF_ROLES = [
  ('nonexec','非常勤役員'), ('worker','工員'), ('clerk','事務員'), ('engineer','技術者'),
  ('sales','販売員'), ('labor','労務者'), ('cook','料理人'), ('hostess','ホステス'), ('other','その他')
] %}
{% set OPTIONS_PC_OS = [('win','Windows'), ('mac','Mac'), ('linux','Linux'), ('other','その他')] %}
{% set OPTIONS_PC_USAGE = [('payroll','給与管理'), ('inventory','在庫・販売管理'), ('production','生産管理'), ('accounting','財務管理')] %}
{% set OPTIONS_ECOMMERCE = [('sales','有・売上'), ('purchase','有・仕入'), ('expense','有・経費'), ('none','無')] %}
{% set OPTIONS_DATA_STORAGE = [('cloud','クラウド'), ('external','外部記録媒体'), ('server','PCサーバ')] %}

{% block title %}事業概況説明書１{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/filings_business_overview.css') }}">
{% endblock %}

{% block content %}
<h1 class="content-title">事業概況説明書１</h1>
<p class="content-subtitle">支店・子会社の状況（入力のみ・保存は未対応）</p>

<div class="bo-split-pane">
  <div class="bo-pane-left">
    <div class="card">
      <form method="get" novalidate>
        <fieldset>
          <legend>支店の状況</legend>
          {% call bo.grid(2) %}
            {{ bo.field('国内支店（国内に所在する支店等の総数）', type='number', placeholder='例：3', name='bo1.branches.domestic_count') }}
            {{ bo.spacer() }}
            {{ bo.field('海外支店（海外に所在する支店等の総数）', type='number', placeholder='例：1', classes='bo-col-1', name='bo1.branches.overseas_count') }}
            {{ bo.spacer() }}

            {{ bo.field('海外支店の所在地国１', type='text', placeholder='例：米国カリフォルニア州…', name='bo1.branches.overseas_country1') }}
            {{ bo.field('所在地国１の従業員数', type='number', placeholder='例：30', name='bo1.branches.overseas_country1_employees') }}
            {{ bo.field('海外支店の所在地国２', type='text', placeholder='例：シンガポール', name='bo1.branches.overseas_country2') }}
            {{ bo.field('所在地国２の従業員数', type='number', placeholder='例：20', name='bo1.branches.overseas_country2_employees') }}
          {% endcall %}
        </fieldset>

        <fieldset>
          <legend>子会社の状況</legend>
          {% call bo.grid(2) %}
            {{ bo.field('国内子会社の数', type='number', placeholder='例：2', name='bo1.subsidiaries.domestic_count') }}
            {{ bo.spacer() }}
            {{ bo.field('海外子会社の数', type='number', placeholder='例：1', classes='bo-col-1', name='bo1.subsidiaries.overseas_count') }}
            {{ bo.field('うち出資割合が50％以上の海外子会社数', type='number', placeholder='例：1', name='bo1.subsidiaries.overseas_majority_count') }}

            {{ bo.field('海外子会社１の名称', type='text', placeholder='例：〇〇インターナショナル株式会社', name='bo1.subsidiaries.overseas1_name') }}
            {{ bo.field('海外子会社１の出資割合', type='number', placeholder='例：60', name='bo1.subsidiaries.overseas1_share') }}

            {{ bo.field('海外子会社２の名称', type='text', placeholder='例：△△テクノロジーズ株式会社', name='bo1.subsidiaries.overseas2_name') }}
            {{ bo.field('海外子会社２の出資割合', type='number', placeholder='例：40', name='bo1.subsidiaries.overseas2_share') }}
          {% endcall %}
        </fieldset>

        <fieldset>
          <legend>海外取引状況</legend>
          <!-- Overseas Trade: row1 (radio, span all) -->
          {% call bo.grid(2) %}
            {{ bo.segmented('海外取引の種類', 'trade_type', 'radio',
              options=[('import','輸入'), ('export','輸出'), ('both','輸出入'), ('none','無')],
              span_all=True, container_id='trade_type_group') }}
          {% endcall %}

          <!-- Overseas Trade: rows 2-3 (3-col) -->
          {% call bo.grid(3, 'bo-grid-3col bo-cols-3') %}
            {{ bo.field('輸出相手国', type='text', placeholder='例：米国', name='bo1.trade.export_country') }}
            {{ bo.field('主な商品', type='text', placeholder='例：電子機器', name='bo1.trade.export_item') }}
            {{ bo.field('取引金額（百万円）', type='number', placeholder='例：200', name='bo1.trade.export_amount_million') }}

            {{ bo.field('輸入相手国', type='text', placeholder='例：中国', name='bo1.trade.import_country') }}
            {{ bo.field('主な商品', type='text', placeholder='例：電子部品', name='bo1.trade.import_item') }}
            {{ bo.field('取引金額（百万円）', type='number', placeholder='例：120', name='bo1.trade.import_amount_million') }}
          {% endcall %}

          <!-- Overseas Trade: rows 4-6 (checkbox + text, span all) -->
          {% call bo.grid(2) %}
            {{ bo.segmented('輸出入以外の海外取引（複数選択可）', 'trade_type_other', 'checkbox',
              options=[('securities','証券の売買'), ('loan','金銭の貸借'), ('realestate','不動産の売買')],
              span_all=True, container_id='trade_type_other_row1', id_prefix='trade_other') }}

            {{ bo.segmented('', 'trade_type_other', 'checkbox',
              options=[('fee','手数料'), ('royalty','ロイヤルティー'), ('services','役務の提供')],
              span_all=True, container_id='trade_type_other_row2', id_prefix='trade_other') }}

            {{ bo.field('その他', type='text', placeholder='輸出入以外の海外取引で上記に該当がない場合に入力してください', classes='bo-span-all', name='bo1.trade.other_text') }}
          {% endcall %}        </fieldset>

        <fieldset>
          <legend>期末従事員等の状況</legend>

          {# 職種（6カラム・名称は後で指示） #}
          {% call bo.grid(6, 'bo-cols-6 bo-workers-roles') %}
            <div class="form-group bo-span-all"><label class="form-label">期末従事員の状況</label></div>
            <div class="form-group bo-cell-center">
              <div class="bo-input-frame" role="text" aria-readonly="true">常勤役員</div>
            </div>
            {{ bo.select(None, OPTIONS_STAFF_ROLES, name='bo1.staff.role2') }}
            {{ bo.select(None, OPTIONS_STAFF_ROLES, name='bo1.staff.role3') }}
            {{ bo.select(None, OPTIONS_STAFF_ROLES, name='bo1.staff.role4') }}
            {{ bo.select(None, OPTIONS_STAFF_ROLES, name='bo1.staff.role5') }}
            <div class="form-group bo-cell-center">
              <div class="bo-input-frame" role="text" aria-readonly="true">合計</div>
            </div>
          {% endcall %}

          {% call bo.grid(6, 'bo-cols-6 js-workers-count') %}
            {{ bo.field(type='number', placeholder='例：10', name='bo1.staff.count1') }}
            {{ bo.field(type='number', placeholder='例：5',  name='bo1.staff.count2') }}
            {{ bo.field(type='number', placeholder='例：8',  name='bo1.staff.count3') }}
            {{ bo.field(type='number', placeholder='例：2',  name='bo1.staff.count4') }}
            {{ bo.field(type='number', placeholder='例：1',  name='bo1.staff.count5') }}
            <div class="form-group bo-cell-center">
              <div class="bo-input-frame js-total" role="text" aria-live="polite" style="text-align:center;">0</div>
            </div>
          {% endcall %}

          {# 合計の内訳（2カラム） #}
          {% call bo.grid(2) %}
            {{ bo.field('合計のうち代表者家族数', type='number', placeholder='例：1', name='bo1.staff.family_count') }}
            {{ bo.field('合計のうちアルバイト数', type='number', placeholder='例：3', name='bo1.staff.part_time_count') }}
          {% endcall %}

          {# 賃金の決め方（ラジオ） #}
          {% call bo.grid(2) %}
            {{ bo.segmented('賃金の定め方', 'wage_policy', 'radio',
              options=[('A','A固定給'), ('B','B歩合給'), ('AB','AB併用')],
              span_all=True, container_id='wage_policy_group', id_prefix='wage_policy') }}
          {% endcall %}

          {# 社宅の有無（ラジオ） #}
          {% call bo.grid(2) %}
            {{ bo.segmented('社宅・寮の有無', 'company_housing', 'radio',
              options=[('yes','有'), ('no','無')],
              span_all=True, container_id='company_housing_group', id_prefix='company_housing') }}
          {% endcall %}        </fieldset>

        <fieldset>
          <legend>PC利用状況</legend>

          {% call bo.grid(2) %}
            {{ bo.segmented('PC利用の有無', 'pc_usage_exists', 'radio',
              options=[('yes','有'), ('no','無')],
              span_all=True, container_id='pc_usage_exists', id_prefix='pc_usage_exists') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.segmented('PCのOS', 'pc_os', 'checkbox',
              options=OPTIONS_PC_OS,
              span_all=True, container_id='pc_os', id_prefix='pc_os') }}
          {% endcall %}

          {% call bo.grid(2, 'bo-os-other-grid') %}
            {{ bo.field(None, type='text', placeholder='OS名を入力', classes='bo-span-all bo-os-other-field', name='bo1.pc.os_other') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.segmented('PCの利用形態', 'pc_usage', 'checkbox',
              options=OPTIONS_PC_USAGE,
              span_all=True, container_id='pc_usage', id_prefix='pc_usage') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.segmented('会計ソフトの利用等', 'accounting_software_usage', 'radio',
              options=[('yes','有'), ('no','無')],
              span_all=True, container_id='accounting_software_usage', id_prefix='accounting_software_usage') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.field('会計ソフト名', type='text', placeholder='例：弥生会計、freee など', name='bo1.pc.accounting_software') }}
            {{ bo.field('メールソフト名', type='text', placeholder='例：Outlook、Gmail など', name='bo1.pc.mail_software') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.segmented('データの保存先', 'data_storage', 'checkbox',
              options=OPTIONS_DATA_STORAGE,
              span_all=True, container_id='data_storage', id_prefix='data_storage') }}
          {% endcall %}        </fieldset>

        <fieldset>
          <legend>販売形態</legend>

          {% call bo.grid(2) %}
            {{ bo.segmented('電子商取引（インターネット取引）', 'ecommerce', 'checkbox',
              options=OPTIONS_ECOMMERCE,
              span_all=True, container_id='ecommerce', id_prefix='ecommerce') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.segmented('販売チャネル', 'sales_channel', 'radio',
              options=[('own','自社HP'), ('others','他社HP')],
              span_all=True, container_id='sales_channel', id_prefix='sales_channel') }}
          {% endcall %}        </fieldset>

        <fieldset>
          <legend>株主又は株式所有異動</legend>
          {% call bo.grid(2) %}
            {{ bo.segmented('株主又は株式所有異動の有無', 'shareholder_change', 'radio',
              options=[('yes','有'), ('no','無')],
              span_all=True, container_id='shareholder_change', id_prefix='shareholder_change') }}
          {% endcall %}        </fieldset>

        <fieldset>
          <legend>経理の状況</legend>

          {% call bo.grid(2) %}
            {{ bo.field('現金管理者', type='text', placeholder='氏名等', name='bo1.accounting.cash_manager') }}
            {{ bo.segmented('代表者との関係', 'cash_manager_relation', 'radio',
              options=[('relative','親族'), ('other','他人')],
              span_all=False, container_id='cash_manager_relation', id_prefix='cash_mgr_rel') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.field('通帳管理者', type='text', placeholder='氏名等', name='bo1.accounting.passbook_manager') }}
            {{ bo.segmented('代表者との関係', 'passbook_manager_relation', 'radio',
              options=[('relative','親族'), ('other','他人')],
              span_all=False, container_id='passbook_manager_relation', id_prefix='passbook_mgr_rel') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.segmented('試算表の作成状況', 'trial_balance_status', 'radio',
              options=[('monthly','毎月'), ('roughly_monthly','おおむね月ごと'), ('year_end','決算時のみ')],
              span_all=True, container_id='trial_balance_status', id_prefix='trial_balance_status') }}
          {% endcall %}

          {% call bo.grid(2, 'bo-withholding') %}
            {{ bo.segmented('源泉徴収対象所得', 'withholding_income', 'checkbox',
              options=[('salary','給与'), ('fee','報酬・料金'), ('interest','利子等')],
              span_all=True, container_id='withholding_income_row1', id_prefix='withholding_income') }}
            {{ bo.segmented('', 'withholding_income', 'checkbox',
              options=[('dividend','配当'), ('nonresident','非居住者'), ('retirement','退職')],
              span_all=True, container_id='withholding_income_row2', id_prefix='withholding_income') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.field('消費税の当期課税売上高（千円）', type='number', placeholder='例：12345', classes='bo-span-all', name='bo1.tax.vat_taxable_sales_thousand') }}
          {% endcall %}

          {% call bo.grid(2) %}
            {{ bo.segmented('社内監査実施の有無', 'internal_audit', 'radio',
              options=[('yes','有'), ('no','無')],
              span_all=False, container_id='internal_audit', id_prefix='internal_audit') }}
            <div class="form-group"><label class="form-label" aria-hidden="true" style="visibility:hidden">社内監査実施の有無</label><input class="form-control" type="text" name='bo1.audit.checksheet_name' placeholder='社内監査のチェックシート名称'></div>
          {% endcall %}
        </fieldset>

      </form>
    </div>
  </div>

  <div class="bo-aside-spacer" aria-hidden="true"></div>

  <aside class="bo-pane-right">
    <div class="bo-preview-card">
      <div class="bo-preview-box" style="padding:0;">
        <iframe src="{{ url_for('company.filings_preview', page='business_overview_1') }}#toolbar=0&navpanes=0&view=FitH" title="PDFプレビュー" style="width:100%; height:100%; border:0; border-radius:8px; background:#fff;"></iframe>
      </div>
      <p class="bo-preview-note">PDFの実ファイルを表示中（読み取り専用）。入力との連動は今後の段階で実装します。</p>
    </div>
  </aside>
</div>
{% endblock %}

{% block scripts %}
  {{ super() if super }}
  <script>
    (function(){
      var radios = document.querySelectorAll('input[type="radio"][name="trade_type"]');
      radios.forEach(function(el){
        el.addEventListener('mousedown', function(){ this._wasChecked = this.checked; });
        el.addEventListener('click', function(){ if (this._wasChecked) { this.checked = false; } });
      });
    })();
    (function(){
      var checks = document.querySelectorAll('input[type="checkbox"][name="trade_type_other"]');
      function syncOne(el){
        var lab = document.querySelector('label[for="'+el.id+'"]');
        if(lab){ lab.classList.toggle('is-checked', el.checked); }
      }
      checks.forEach(function(el){
        el.addEventListener('change', function(){ syncOne(el); });
        syncOne(el);
      });
      var labels = document.querySelectorAll('label[for^="trade_other_"]');
      labels.forEach(function(lab){
        lab.addEventListener('click', function(e){
          e.preventDefault();
          var id = this.getAttribute('for');
          var el = document.getElementById(id);
          if(!el) return;
          el.checked = !el.checked;
          el.dispatchEvent(new Event('change', {bubbles:true}));
        });
      });
    })();
  </script>
  <script>
    (function(){
      var split = document.querySelector('.bo-split-pane');
      var aside = document.querySelector('.bo-pane-right');
      var left  = document.querySelector('.bo-pane-left');
      var leftCard = document.querySelector('.bo-pane-left .card');
      if(!split || !aside || !left || !leftCard) return;

      var headerH = 56;
      try {
        var cssH = getComputedStyle(document.documentElement).getPropertyValue('--header-height');
        if(cssH) { var n = parseInt(cssH, 10); if(!isNaN(n)) headerH = n; }
      } catch(e){}
      var topOffset = headerH + 16;

      var gutterBase = null;
      var wasFixed = false;

      function computeGutter(splitRect, asideRect){
        return Math.round((splitRect.left + splitRect.width) - (asideRect.left + asideRect.width));
      }
      function computeLeftForFixed(splitRect, asideWidth){
        var pageX = window.pageXOffset || document.documentElement.scrollLeft || 0;
        var gutter = (gutterBase == null ? 0 : gutterBase);
        return Math.round(splitRect.left + pageX + split.clientWidth - asideWidth - gutter);
      }

      function tick(){
        var splitRect = split.getBoundingClientRect();
        var asideRect = aside.getBoundingClientRect();
        var w = asideRect.width;
        var start = leftCard.getBoundingClientRect().top + window.pageYOffset;
        var sc = window.pageYOffset + topOffset;

        if(!wasFixed){
          gutterBase = computeGutter(splitRect, asideRect);
        }
        if(sc >= start){
          aside.style.position = 'fixed';
          aside.style.top = topOffset + 'px';
          aside.style.width = w + 'px';
          aside.style.left = computeLeftForFixed(splitRect, w) + 'px';
          left.style.paddingRight = (w + 24) + 'px';
          wasFixed = true;
        } else {
          aside.style.position = '';
          aside.style.top = '';
          aside.style.left = '';
          aside.style.width = '';
          left.style.paddingRight = '';
          wasFixed = false;
        }
      }
      window.addEventListener('scroll', tick, {passive:true});
      window.addEventListener('resize', function(){
        var was = wasFixed;
        aside.style.position = '';
        aside.style.left = '';
        wasFixed = false;
        tick();
        if(was){ tick(); }
      });
      tick();
    })();
  </script>
  <script>
    (function(){
      var container = document.querySelector('.js-workers-count');
      if(!container) return;
      var srcSel = container.getAttribute('data-total-source') || 'input.form-control[type="number"]';
      var tgtSel = container.getAttribute('data-total-target') || '.js-total';
      var nums = Array.prototype.slice.call(container.querySelectorAll(srcSel));
      if(nums.length < 1) return;
      var total = container.querySelector(tgtSel);
      if(!total){
        var totalInput = container.querySelector('input.js-total');
        var totalDisplay = container.querySelector('.js-total');
        total = totalInput || totalDisplay || nums[nums.length - 1];
      }
      if(!total) return;
      if(total.tagName === 'INPUT'){
        total.readOnly = true;
        total.setAttribute('aria-readonly', 'true');
      }
      function toNumber(el){
        var v = (el.value || '').replace(/,/g,'').trim();
        if(v === '') return 0;
        var n = Number(v);
        return isFinite(n) ? n : 0;
      }
      function recalc(){
        var sum = 0;
        for(var i=0;i<nums.length;i++){
          var el = nums[i];
          if(el === total) continue;
          sum += toNumber(el);
        }
        var s = String(sum);
        if(total.tagName === 'INPUT'){
          if(s !== total.value){ total.value = s; }
        } else {
          if(s !== total.textContent){ total.textContent = s; }
        }
      }
      nums.forEach(function(el){ if(el !== total){ el.addEventListener('input', recalc); }});
      recalc();
    })();
  </script>
  <script>
    (function(){
      var other = document.getElementById('pc_os_other');
      var wrap = document.querySelector('.bo-os-other-field');
      var grid = document.querySelector('.bo-os-other-grid');
      if(!other) return;
      function sync(){
        var on = !!other.checked;
        if(wrap) wrap.classList.toggle('is-visible', on);
        if(grid) grid.classList.toggle('is-on', on);
      }
      other.addEventListener('change', sync);
      sync();
    })();
  </script>
{% endblock %}