{% extends 'base.html' %}
{% import 'company/_bo_grid_macros.html' as bo %}
{% from '_components/preview_aside.html' import preview_aside %}

{% block title %}事業概況説明書２{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/filings_business_overview.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/financial_statements.css') }}">
{% endblock %}

{% block content %}
<h1 class="content-title">事業概況説明書２</h1>
<p class="content-subtitle">主要科目の内訳（単位：千円）</p>

<div class="bo-split-pane">
  <div class="bo-pane-left">
    
    {% from "company/_layout_helpers.html" import render_statement_table %}
    {% if bs_data %}
    <div class="card">
      <section class="statement-section">
        <div class="bs-container">
          <div class="bs-column">
            {% set assets = bs_data.get('資産', {}) %}
            {% set asset_order = ['流動資産', '固定資産', '繰延資産'] %}
            {{ render_statement_table('資産の部', assets, order=asset_order) }}
            <div class="table-responsive total-table-wrapper">
              <table class="table table-bordered statement-table">
                <tbody>
                  <tr class="total-row major-total">
                    <td>資産合計</td>
                    <td class="amount">{{ "{:,.0f}".format(assets.get('total', 0)) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="bs-column">
            {% set liabilities = bs_data.get('負債', {}) %}
            {% set liability_order = ['流動負債', '固定負債'] %}
            {{ render_statement_table('負債の部', liabilities, order=liability_order) }}

            <div style="margin-top: 2rem;">
              {% set equity = bs_data.get('純資産', {}) %}
              {% set equity_order = ['株主資本', '評価・換算差額等', '新株予約権'] %}
              {{ render_statement_table('純資産の部', equity, order=equity_order) }}
            </div>

            <div class="table-responsive total-table-wrapper">
              <table class="table table-bordered statement-table">
                <tbody>
                  <tr class="total-row major-total">
                    <td>負債・純資産合計</td>
                    <td class="amount">{{ "{:,.0f}".format(liabilities.get('total', 0) + equity.get('total', 0)) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
    
    {# ダイジェスト版（連動中）: 残高試算表の一部科目のみを表示 #}
    {%- macro fmt_blank(val) -%}
      {%- set v = (val | default(0)) -%}
      {%- if v is string -%}
        {%- set _ = namespace()%}
        {# 文字列なら数値に変換を試みる（非数は0扱い） #}
        {%- set v = (v | replace(',', '') | float | default(0)) -%}
      {%- endif -%}
      {%- if (v | default(0)) == 0 -%}{%- else -%}{{ "{:,.0f}".format(v | default(0)) }}{%- endif -%}
    {%- endmacro -%}
    {%- macro sum_from_bs(major, names) -%}
      {%- set ns = namespace(total=0) -%}
      {%- set major_obj = bs_data.get(major, {}) -%}
      {%- for middle, obj in major_obj.items() if middle != 'total' -%}
        {%- for item in obj.get('items', []) -%}
          {%- if item.name in names -%}
            {%- set ns.total = ns.total + (item.amount or 0) -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ ns.total }}
    {%- endmacro -%}
    {%- set assets_total = bs_data.get('資産', {}).get('total', 0) -%}
    {%- set liabilities_total = bs_data.get('負債', {}).get('total', 0) -%}
    {%- set equity_total = bs_data.get('純資産', {}).get('total', 0) -%}
    {%- set other_borrowings_base = (sum_from_bs('負債', ['短期借入金','長期借入金']) | float) -%}
    {%- set personal_loans_q = request.args.get('bo2.bs.personal_loans') -%}
    {%- set personal_loans_val = (personal_loans_q.replace(',', '') | float) if personal_loans_q else 0 -%}
    {%- set other_borrowings_initial = other_borrowings_base - personal_loans_val -%}

    <div class="card" style="margin-top: 16px;">
      <section class="statement-section">
        <div class="bs-container">
          <!-- 左カラム: 資産の部（ダイジェスト） -->
          <div class="bs-column">
            <div class="table-responsive">
              <table class="table table-bordered statement-table">
                <tbody>
                  <tr class="total-row major-total">
                    <td>資産の部合計</td>
                    <td class="amount">{{ fmt_blank(assets_total) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">現金預金</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['現金及び預金'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">受取手形</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['受取手形'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">売掛金</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['売掛金'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">棚卸資産（未成工事支出金）</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['商品','製品','半製品','原材料','仕掛品','貯蔵品','未成工事支出金'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">貸付金</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['貸付金','短期貸付金','長期貸付金'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">建物</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['建物'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">機械装置</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['機械装置'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">車両・船舶</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['車両運搬具','船舶'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">土地</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('資産', ['土地'])) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 右カラム: 負債・純資産（ダイジェスト） -->
          <div class="bs-column">
            <div class="table-responsive">
              <table class="table table-bordered statement-table">
                <tbody>
                  <tr class="total-row major-total">
                    <td>負債の部合計</td>
                    <td class="amount">{{ fmt_blank(liabilities_total) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">支払手形</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('負債', ['支払手形'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">買掛金</td>
                    <td class="amount">{{ fmt_blank(sum_from_bs('負債', ['買掛金'])) }}</td>
                  </tr>
                  <tr>
                    <td class="account-name">個人借入金</td>
                    <td class="amount"></td>
                  </tr>
                  <tr>
                    <td class="account-name">その他の借入金</td>
                    <td class="amount"><span id=\"digest-other-borrowings\" data-base=\"{{ other_borrowings_base }}\" style=\"display:inline-block; width:100%; text-align:right;\">{{ fmt_blank(other_borrowings_initial) }}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="table-responsive total-table-wrapper" style="margin-top: 1.5rem;">
              <table class="table table-bordered statement-table">
                <tbody>
                  <tr class="total-row major-total">
                    <td>純資産の部合計</td>
                    <td class="amount">{{ fmt_blank(equity_total) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
{% endif %}
<div class="card">
      <form method="get" novalidate>
        <fieldset>
          <legend>主要科目（損益・貸借）</legend>
          {% call bo.grid(2) %}
            {# 左列（損益） #}
            {{ bo.field('売上高', type='number', placeholder='例：5280', name='bo2.pl.sales') }}
            {# 右列（資産の部 合計） #}
            {{ bo.field('資産の部合計', type='number', placeholder='', name='bo2.bs.total_assets') }}

            {{ bo.field('上記のうち営業売上高', type='number', placeholder='', name='bo2.pl.operating_sales') }}
            {{ bo.field('現金預金', type='number', placeholder='', name='bo2.bs.cash') }}

            {# 売上原価のうち #}
            <div class="form-group bo-span-all"><label class="form-label">売上原価のうち</label></div>
            {{ bo.field('受取手形', type='number', placeholder='', name='bo2.bs.notes_receivable') }}
            {{ bo.field('期首棚卸高', type='number', placeholder='', name='bo2.pl.cogs.begin_inventory') }}
            {{ bo.field('売掛金', type='number', placeholder='例：660', name='bo2.bs.accounts_receivable') }}
            {{ bo.field('期末棚卸高', type='number', placeholder='', name='bo2.pl.cogs.end_inventory') }}
            {{ bo.field('棚卸資産（未成工事支出金）', type='number', placeholder='', name='bo2.bs.inventory') }}
            {{ bo.field('原材料費', type='number', placeholder='', name='bo2.pl.cogs.materials') }}
            {{ bo.field('貸付金', type='number', placeholder='', name='bo2.bs.loans_receivable') }}
            {{ bo.field('労務費', type='number', placeholder='', name='bo2.pl.cogs.labor') }}
            {{ bo.field('建物', type='number', placeholder='', name='bo2.bs.buildings') }}
            {{ bo.field('外注費', type='number', placeholder='', name='bo2.pl.cogs.outsourcing') }}
            {{ bo.field('機械装置', type='number', placeholder='', name='bo2.bs.machinery') }}
            {{ bo.field('減価償却費', type='number', placeholder='', name='bo2.pl.cogs.depreciation') }}
            {{ bo.field('車両・船舶', type='number', placeholder='例：587', name='bo2.bs.vehicles') }}
            {{ bo.field('地代家賃', type='number', placeholder='', name='bo2.pl.cogs.rent') }}
            {{ bo.field('土地', type='number', placeholder='', name='bo2.bs.land') }}

            {{ bo.field('売上総利益', type='number', placeholder='例：5280', name='bo2.pl.gross_profit') }}
            {{ bo.field('負債の部合計', type='number', placeholder='', name='bo2.bs.total_liabilities') }}

            {{ bo.field('役員報酬', type='number', placeholder='例：960', name='bo2.pl.executive_comp') }}
            {{ bo.field('支払手形', type='number', placeholder='', name='bo2.bs.notes_payable') }}

            {{ bo.field('従業員給料', type='number', placeholder='例：225', name='bo2.pl.employee_salary') }}
            {{ bo.field('買掛金', type='number', placeholder='', name='bo2.bs.accounts_payable') }}

            {{ bo.field('交際費', type='number', placeholder='例：242', name='bo2.pl.entertainment') }}
            {{ bo.field('個人借入金', type='number', placeholder='例：37', name='bo2.bs.personal_loans') }}

            {{ bo.field('減価償却費（販管費）', type='number', placeholder='例：549', name='bo2.pl.sga.depreciation') }}
            {{ bo.field('その他の借入金', type='number', placeholder='例：4000', name='bo2.bs.other_borrowings') }}

            {{ bo.field('地代家賃（販管費）', type='number', placeholder='例：672', name='bo2.pl.sga.rent') }}
            {{ bo.field('純資産の部合計', type='number', placeholder='例：7290', name='bo2.bs.total_net_assets') }}

            {{ bo.field('営業損益', type='number', placeholder='例：816', name='bo2.pl.operating_income') }}
            {{ bo.spacer() }}
            {{ bo.field('特別利益', type='number', placeholder='', name='bo2.pl.extraordinary_income') }}
            {{ bo.spacer() }}
            {{ bo.field('特別損失', type='number', placeholder='', name='bo2.pl.extraordinary_loss') }}
            {{ bo.spacer() }}
            {{ bo.field('税引前当期損益', type='number', placeholder='例：1856', name='bo2.pl.pre_tax_income') }}
            {{ bo.spacer() }}
          {% endcall %}
        </fieldset>
      </form>
    </div>
  </div>

  <div class="bo-aside-spacer" aria-hidden="true"></div>

  {{ preview_aside(preview_src, has_preview, 'PDFの実ファイルを表示中（読み取り専用）。入力との連動は今後の段階で実装します。') }}
</div>
{% endblock %}

{% block scripts %}
  {{ super() if super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var span = document.getElementById('digest-other-borrowings');
      if (!span) return;
      var base = parseFloat(span.dataset.base || '0') || 0;
      var input = document.querySelector('input[name="bo2.bs.personal_loans"]');
      function format(v){ v = Math.round(v); return v === 0 ? '' : v.toLocaleString('ja-JP'); }
      function update(){
        var raw = input ? (input.value || '') : '';
        raw = raw.replace(/,/g,'').replace(/，/g,'').replace(/ /g,'').trim();
        var personal = parseFloat(raw) || 0;
        span.textContent = format(base - personal);
      }
      update();
      if (input) input.addEventListener('input', update);
    });
  </script>
{% endblock %}
