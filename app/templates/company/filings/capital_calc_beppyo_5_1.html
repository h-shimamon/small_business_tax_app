{% extends 'base.html' %}
{% block title %}資本金等の額の計算（別表５(1)）{% endblock %}
{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/corporate_tax_calculation.css') }}">
  <style>
    .beppyo5-sheet {
      display: grid;
      grid-template-columns: 170px 170px 110px 160px 160px 80px 80px 160px;
      grid-auto-rows: minmax(50px, auto);
      border: 1px solid #d8dce3;
      background: #fff;
    }
    .beppyo5-sheet .cell {
      border: 1px solid #d8dce3;
      padding: 0.45rem 0.6rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      background: #fff;
      white-space: normal;
    }
    .beppyo5-sheet .cell.header {
      background: #f7f8fb;
      font-weight: 600;
    }
    .beppyo5-sheet .cell.center {
      justify-content: center;
      text-align: center;
    }
    .beppyo5-sheet .cell .beppyo5-input {
      width: 100%;
      height: 100%;
      min-height: 1.8rem;
      border: 1px solid #d8dce3;
      background: #fdfdff;
      font: inherit;
      padding: 0.2rem 0.4rem;
      box-sizing: border-box;
      align-self: stretch;
      border-radius: 4px;
      transition: border-color 0.15s ease, background 0.15s ease;
    }
    .beppyo5-sheet .cell .beppyo5-input:focus {
      border-color: #1f4bd8;
      background: #ffffff;
      outline: none;
      box-shadow: 0 0 0 2px rgba(31, 75, 216, 0.1);
    }
    .beppyo5-sheet .cell .beppyo5-input::placeholder {
      color: #9aa2b1;
    }
    .beppyo5-sheet .cell .beppyo5-input::placeholder {
      color: #9aa2b1;
    }
    .beppyo5-sheet .cell.vertical {
      writing-mode: vertical-rl;
      text-orientation: upright;
      justify-content: center;
      align-items: center;
    }
    .beppyo5-sheet .cell.small {
      font-size: 0.88rem;
      line-height: 1.4;
    }
    .beppyo5-hint {
      margin-bottom: 1rem;
      color: #566172;
      font-size: 0.9rem;
    }
  </style>
{% endblock %}
{% block content %}
<h1 class="content-title">資本金等の額の計算（別表５(1)）</h1>
<p class="beppyo5-hint">利益積立金額の計算（別表５(1)）のレイアウトをベースに調整できます。</p>
<div class="beppyo5-sheet">
  <!-- Header -->
  <div class="cell header center" style="grid-column: 1 / span 3; grid-row: 1 / span 3;">区分</div>
  <div class="cell header center" style="grid-column: 4; grid-row: 1 / span 2;">期首現在<br>資本金等</div>
  <div class="cell header center" style="grid-column: 5 / span 3; grid-row: 1;">当期の増減</div>
  <div class="cell header center" style="grid-column: 5; grid-row: 2;">減</div>
  <div class="cell header center" style="grid-column: 6 / span 2; grid-row: 2;">増</div>
  <div class="cell header center" style="grid-column: 8; grid-row: 1 / span 2;">差引翌期首現在<br>資本金等</div>

  <div class="cell center" style="grid-column: 4; grid-row: 3;">①</div>
  <div class="cell center" style="grid-column: 5; grid-row: 3;">②</div>
  <div class="cell center" style="grid-column: 6 / span 2; grid-row: 3;">③</div>
  <div class="cell center" style="grid-column: 8; grid-row: 3;">④</div>

  <!-- Rows cloned from beppyo_5_1 for further editing -->
  <div class="cell" style="grid-column: 1 / span 2; grid-row: 4;">資本金又は出資金</div>
  <div class="cell center" style="grid-column: 3; grid-row: 4;">1</div>
  <div class="cell js-col1-static js-row-capital-source" style="grid-column: 4; grid-row: 4;">{{ capital_stock_amount | format_number }}</div>
  <div class="cell" style="grid-column: 5; grid-row: 4;"><input type="text" class="beppyo5-input js-col2-input js-row-capital-input" aria-label="区分1 減"></div>
  <div class="cell" style="grid-column: 6 / span 2; grid-row: 4;"><input type="text" class="beppyo5-input js-col3-input js-row-capital-input" aria-label="区分1 増"></div>
  <div class="cell beppyo5-total js-row-capital-total" style="grid-column: 8; grid-row: 4;">0</div>

  <div class="cell" style="grid-column: 1 / span 2; grid-row: 5;">資本準備金</div>
  <div class="cell center" style="grid-column: 3; grid-row: 5;">2</div>
  <div class="cell" style="grid-column: 4; grid-row: 5;"><input type="text" inputmode="decimal" class="beppyo5-input js-col1-input js-row-reserve-input" aria-label="区分2 期首現在資本金等"></div>
  <div class="cell" style="grid-column: 5; grid-row: 5;"><input type="text" class="beppyo5-input js-col2-input js-row-reserve-input" aria-label="区分2 減"></div>
  <div class="cell" style="grid-column: 6 / span 2; grid-row: 5;"><input type="text" class="beppyo5-input js-col3-input js-row-reserve-input" aria-label="区分2 増"></div>
  <div class="cell beppyo5-total js-row-reserve-total" style="grid-column: 8; grid-row: 5;">0</div>

  <div class="cell" style="grid-column: 1 / span 2; grid-row: 6;"><input type="text" class="beppyo5-input" aria-label="区分 3"></div>
  <div class="cell center" style="grid-column: 3; grid-row: 6;">3</div>
  <div class="cell" style="grid-column: 4; grid-row: 6;"><input type="text" inputmode="decimal" class="beppyo5-input js-col1-input js-row-area3-input" aria-label="区分3 期首現在資本金等"></div>
  <div class="cell" style="grid-column: 5; grid-row: 6;"><input type="text" class="beppyo5-input js-col2-input js-row-area3-input" aria-label="区分3 減"></div>
  <div class="cell" style="grid-column: 6 / span 2; grid-row: 6;"><input type="text" class="beppyo5-input js-col3-input js-row-area3-input" aria-label="区分3 増"></div>
  <div class="cell beppyo5-total js-row-area3-total" style="grid-column: 8; grid-row: 6;">0</div>

  <div class="cell" style="grid-column: 1 / span 2; grid-row: 7;"><input type="text" class="beppyo5-input" aria-label="区分 4"></div>
  <div class="cell center" style="grid-column: 3; grid-row: 7;">4</div>
  <div class="cell" style="grid-column: 4; grid-row: 7;"><input type="text" inputmode="decimal" class="beppyo5-input js-col1-input js-row-area4-input" aria-label="区分4 期首現在資本金等"></div>
  <div class="cell" style="grid-column: 5; grid-row: 7;"><input type="text" class="beppyo5-input js-col2-input js-row-area4-input" aria-label="区分4 減"></div>
  <div class="cell" style="grid-column: 6 / span 2; grid-row: 7;"><input type="text" class="beppyo5-input js-col3-input js-row-area4-input" aria-label="区分4 増"></div>
  <div class="cell beppyo5-total js-row-area4-total" style="grid-column: 8; grid-row: 7;">0</div>

  <div class="cell" style="grid-column: 1 / span 2; grid-row: 8;">差引合計額</div>
  <div class="cell center" style="grid-column: 3; grid-row: 8;">5</div>
  <div class="cell beppyo5-total js-col1-total" style="grid-column: 4; grid-row: 8;">0</div>
  <div class="cell beppyo5-total js-col2-total" style="grid-column: 5; grid-row: 8;">0</div>
  <div class="cell beppyo5-total js-col3-total" style="grid-column: 6 / span 2; grid-row: 8;">0</div>
  <div class="cell beppyo5-total js-row-area5-total" style="grid-column: 8; grid-row: 8;">0</div>

</div>
<script>
  (function() {
    const col1Inputs = document.querySelectorAll('.js-col1-input');
    const col1Total = document.querySelector('.js-col1-total');
    const col1StaticCells = document.querySelectorAll('.js-col1-static');
    const col2Inputs = document.querySelectorAll('.js-col2-input');
    const col2Total = document.querySelector('.js-col2-total');
    const col3Inputs = document.querySelectorAll('.js-col3-input');
    const col3Total = document.querySelector('.js-col3-total');
    const rowCapitalInputs = document.querySelectorAll('.js-row-capital-input');
    const rowCapitalTotal = document.querySelector('.js-row-capital-total');
    const rowReserveInputs = document.querySelectorAll('.js-row-reserve-input');
    const rowReserveTotal = document.querySelector('.js-row-reserve-total');
    const rowArea3Inputs = document.querySelectorAll('.js-row-area3-input');
    const rowArea3Total = document.querySelector('.js-row-area3-total');
    const rowArea4Inputs = document.querySelectorAll('.js-row-area4-input');
    const rowArea4Total = document.querySelector('.js-row-area4-total');
    const rowArea5Total = document.querySelector('.js-row-area5-total');

    const allInputs = new Set([
      ...col1Inputs,
      ...col2Inputs,
      ...col3Inputs,
      ...rowCapitalInputs,
      ...rowReserveInputs,
      ...rowArea3Inputs,
      ...rowArea4Inputs,
    ]);

    if (allInputs.size === 0) {
      return;
    }

    const formatter = new Intl.NumberFormat('ja-JP');
    const parseNumber = (value) => {
      if (!value) return 0;
      const normalized = value.replace(/[^0-9.-]/g, '');
      const number = Number(normalized);
      return Number.isFinite(number) ? number : 0;
    };

    const sumSelectors = (entries) => {
      return entries.reduce((sum, entry) => {
        const isTuple = Array.isArray(entry);
        const selector = isTuple ? entry[0] : entry;
        const mode = isTuple ? entry[1] : 'value';
        const element = document.querySelector(selector);
        if (!element) {
          return sum;
        }
        const source = mode === 'text' ? element.textContent : element.value;
        return sum + parseNumber(source || '');
      }, 0);
    };

    const updateTotals = () => {
      let sum1 = 0;
      let sum2 = 0;
      let sum3 = 0;

      if (col1Total) {
        col1Inputs.forEach((input) => {
          sum1 += parseNumber(input.value);
        });
        col1StaticCells.forEach((cell) => {
          sum1 += parseNumber(cell.textContent);
        });
        col1Total.textContent = formatter.format(sum1);
      }

      if (col2Total) {
        col2Inputs.forEach((input) => {
          sum2 += parseNumber(input.value);
        });
        col2Total.textContent = formatter.format(sum2);
      }

      if (col3Total) {
        col3Inputs.forEach((input) => {
          sum3 += parseNumber(input.value);
        });
        col3Total.textContent = formatter.format(sum3);
      }

      if (rowCapitalTotal) {
        const sumRowCapital = sumSelectors([
          ['.js-row-capital-source', 'text'],
          '[aria-label="区分1 減"]',
          '[aria-label="区分1 増"]',
        ]);
        rowCapitalTotal.textContent = formatter.format(sumRowCapital);
      }

      if (rowReserveTotal) {
        const sumRowReserve = sumSelectors([
          '[aria-label="区分2 期首現在資本金等"]',
          '[aria-label="区分2 減"]',
          '[aria-label="区分2 増"]',
        ]);
        rowReserveTotal.textContent = formatter.format(sumRowReserve);
      }

      if (rowArea3Total) {
        const sumRowArea3 = sumSelectors([
          '[aria-label="区分3 期首現在資本金等"]',
          '[aria-label="区分3 減"]',
          '[aria-label="区分3 増"]',
        ]);
        rowArea3Total.textContent = formatter.format(sumRowArea3);
      }

      if (rowArea4Total) {
        const sumRowArea4 = sumSelectors([
          '[aria-label="区分4 期首現在資本金等"]',
          '[aria-label="区分4 減"]',
          '[aria-label="区分4 増"]',
        ]);
        rowArea4Total.textContent = formatter.format(sumRowArea4);
      }

      if (rowArea5Total) {
        const sumRowArea5 = sumSelectors([
          ['.js-col1-total', 'text'],
          ['.js-col2-total', 'text'],
          ['.js-col3-total', 'text'],
        ]);
        rowArea5Total.textContent = formatter.format(sumRowArea5);
      }
    };

    allInputs.forEach((input) => {
      input.addEventListener('input', updateTotals);
      input.addEventListener('change', updateTotals);
    });

    updateTotals();
  })();
</script>
{% endblock %}
