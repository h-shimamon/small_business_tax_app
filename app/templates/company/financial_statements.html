{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/financial_statements.css') }}">
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title-text">{{ title }}</h1>
        <p class="card-subtitle-text">仕訳帳データから自動生成された財務諸表です。</p>
    </div>
    <div class="card-body">
        
        <!-- 損益計算書 -->
        <section class="statement-section">
            <h2>損益計算書 (P/L)</h2>
            <div class="table-responsive">
                <table class="table table-bordered statement-table">
                    <tbody>
                        {% set pl_items = pl_data.get('損益', {}) %}
                        {% set profit_calc = pl_data.get('利益計算', {}) %}

                        <!-- 売上高 -->
                        {% with category = pl_items.get('売上高', {'items': [], 'total': 0}) %}
                            {% for item in category['items'] %}
                                <tr>
                                    <td class="account-name">{{ item.name }}</td>
                                    <td class="amount">{{ "{:,.0f}".format(-item.amount) }}</td>
                                </tr>
                            {% endfor %}
                            <tr class="total-row major-total">
                                <td>売上高合計</td>
                                <td class="amount">{{ "{:,.0f}".format(-category.total) }}</td>
                            </tr>
                        {% endwith %}

                        <!-- 売上原価 -->
                        {% with category = pl_items.get('売上原価', {'items': [], 'total': 0}) %}
                            <tr class="middle-header">
                                <td colspan="2">売上原価</td>
                            </tr>
                            {% for item in category['items'] %}
                            <tr>
                                <td class="account-name indent-1">{{ item.name }}</td>
                                <td class="amount">{{ "{:,.0f}".format(item.amount) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="total-row middle-total">
                                <td class="indent-1">売上原価合計</td>
                                <td class="amount">{{ "{:,.0f}".format(category.total) }}</td>
                            </tr>
                        {% endwith %}
                        
                        <!-- 売上総利益 -->
                        <tr class="total-row major-total profit-row">
                            <td>売上総利益</td>
                            <td class="amount">{{ "{:,.0f}".format(profit_calc.get('売上総利益', {}).get('total', 0)) }}</td>
                        </tr>

                        <!-- 販売費及び一般管理費 -->
                        {% with category = pl_items.get('販売費及び一般管理費', {'items': [], 'total': 0}) %}
                            <tr class="middle-header">
                                <td colspan="2">販売費及び一般管理費</td>
                            </tr>
                            {% for item in category['items'] %}
                            <tr>
                                <td class="account-name indent-1">{{ item.name }}</td>
                                <td class="amount">{{ "{:,.0f}".format(item.amount) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="total-row middle-total">
                                <td class="indent-1">販売費及び一般管理費合計</td>
                                <td class="amount">{{ "{:,.0f}".format(category.total) }}</td>
                            </tr>
                        {% endwith %}

                        <!-- 営業利益 -->
                        <tr class="total-row major-total profit-row">
                            <td>営業利益</td>
                            <td class="amount">{{ "{:,.0f}".format(profit_calc.get('営業利益', {}).get('total', 0)) }}</td>
                        </tr>
                        
                        <!-- 営業外収益 -->
                        {% with category = pl_items.get('営業外収益', {'items': [], 'total': 0}) %}
                            <tr class="middle-header">
                                <td colspan="2">営業外収益</td>
                            </tr>
                            {% for item in category['items'] %}
                            <tr>
                                <td class="account-name indent-1">{{ item.name }}</td>
                                <td class="amount">{{ "{:,.0f}".format(-item.amount) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="total-row middle-total">
                                <td class="indent-1">営業外収益合計</td>
                                <td class="amount">{{ "{:,.0f}".format(-category.total) }}</td>
                            </tr>
                        {% endwith %}

                        <!-- 営業外費用 -->
                        {% with category = pl_items.get('営業外費用', {'items': [], 'total': 0}) %}
                            <tr class="middle-header">
                                <td colspan="2">営業外費用</td>
                            </tr>
                            {% for item in category['items'] %}
                            <tr>
                                <td class="account-name indent-1">{{ item.name }}</td>
                                <td class="amount">{{ "{:,.0f}".format(item.amount) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="total-row middle-total">
                                <td class="indent-1">営業外費用合計</td>
                                <td class="amount">{{ "{:,.0f}".format(category.total) }}</td>
                            </tr>
                        {% endwith %}

                        <!-- 経常利益 -->
                        <tr class="total-row major-total profit-row">
                            <td>経常利益</td>
                            <td class="amount">{{ "{:,.0f}".format(profit_calc.get('経常利益', {}).get('total', 0)) }}</td>
                        </tr>

                        <!-- 特別利益 -->
                        {% with category = pl_items.get('特別利益', {'items': [], 'total': 0}) %}
                            <tr class="middle-header">
                                <td colspan="2">特別利益</td>
                            </tr>
                            {% for item in category['items'] %}
                            <tr>
                                <td class="account-name indent-1">{{ item.name }}</td>
                                <td class="amount">{{ "{:,.0f}".format(-item.amount) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="total-row middle-total">
                                <td class="indent-1">特別利益合計</td>
                                <td class="amount">{{ "{:,.0f}".format(-category.total) }}</td>
                            </tr>
                        {% endwith %}

                        <!-- 特別損失 -->
                        {% with category = pl_items.get('特別損失', {'items': [], 'total': 0}) %}
                            <tr class="middle-header">
                                <td colspan="2">特別損失</td>
                            </tr>
                            {% for item in category['items'] %}
                            <tr>
                                <td class="account-name indent-1">{{ item.name }}</td>
                                <td class="amount">{{ "{:,.0f}".format(item.amount) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="total-row middle-total">
                                <td class="indent-1">特別損失合計</td>
                                <td class="amount">{{ "{:,.0f}".format(category.total) }}</td>
                            </tr>
                        {% endwith %}

                        <!-- 税引前当期純利益 -->
                        <tr class="total-row major-total profit-row">
                            <td>税引前当期純利益</td>
                            <td class="amount">{{ "{:,.0f}".format(profit_calc.get('税引前当期純利益', {}).get('total', 0)) }}</td>
                        </tr>

                        <!-- 法人税等 -->
                        {% with category = pl_items.get('法人税等', {'items': [], 'total': 0}) %}
                            <tr class="middle-header">
                                <td colspan="2">法人税、住民税及び事業税</td>
                            </tr>
                            {% for item in category['items'] %}
                            <tr>
                                <td class="account-name indent-1">{{ item.name }}</td>
                                <td class="amount">{{ "{:,.0f}".format(item.amount) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="total-row middle-total">
                                <td class="indent-1">法人税等合計</td>
                                <td class="amount">{{ "{:,.0f}".format(category.total) }}</td>
                            </tr>
                        {% endwith %}

                        <!-- 当期純利益 -->
                        <tr class="total-row major-total final-profit-row">
                            <td>当期純利益</td>
                            <td class="amount">{{ "{:,.0f}".format(profit_calc.get('当期純利益', {}).get('total', 0)) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 貸借対照表 -->
        <section class="statement-section">
            <h2>貸借対照表 (B/S)</h2>
            <div class="row">
                <!-- 資産の部 -->
                <div class="col-md-6">
                    <div class="table-responsive">
                        <table class="table table-bordered statement-table">
                            <thead>
                                <tr>
                                    <th colspan="2">資産の部</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set assets = bs_data.get('資産', {}) %}
                                {% for middle, data in assets.items() if middle != 'total' %}
                                    <tr class="middle-header">
                                        <td>{{ middle }}</td>
                                        <td class="amount">{{ "{:,.0f}".format(data.get('total', 0)) }}</td>
                                    </tr>
                                    {% for item in data.get('items', []) %}
                                    <tr>
                                        <td class="account-name indent-1">{{ item.name }}</td>
                                        <td class="amount">{{ "{:,.0f}".format(item.amount) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% endfor %}
                                <tr class="total-row major-total">
                                    <td>資産合計</td>
                                    <td class="amount">{{ "{:,.0f}".format(assets.get('total', 0)) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- 負債・純資産の部 -->
                <div class="col-md-6">
                    <div class="table-responsive">
                        <table class="table table-bordered statement-table">
                            <thead>
                                <tr>
                                    <th colspan="2">負債・純資産の部</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set liabilities = bs_data.get('負債', {}) %}
                                <tr class="major-header"><td colspan="2">負債の部</td></tr>
                                {% for middle, data in liabilities.items() if middle != 'total' %}
                                    <tr class="middle-header">
                                        <td>{{ middle }}</td>
                                        <td class="amount">{{ "{:,.0f}".format(data.get('total', 0)) }}</td>
                                    </tr>
                                    {% for item in data.get('items', []) %}
                                    <tr>
                                        <td class="account-name indent-1">{{ item.name }}</td>
                                        <td class="amount">{{ "{:,.0f}".format(item.amount) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% endfor %}
                                <tr class="total-row major-total">
                                    <td>負債合計</td>
                                    <td class="amount">{{ "{:,.0f}".format(liabilities.get('total', 0)) }}</td>
                                </tr>

                                {% set equity = bs_data.get('純資産', {}) %}
                                <tr class="major-header"><td colspan="2">純資産の部</td></tr>
                                {% for middle, data in equity.items() if middle != 'total' %}
                                    <tr class="middle-header">
                                        <td>{{ middle }}</td>
                                        <td class="amount">{{ "{:,.0f}".format(data.get('total', 0)) }}</td>
                                    </tr>
                                    {% for item in data.get('items', []) %}
                                    <tr>
                                        <td class="account-name indent-1">{{ item.name }}</td>
                                        <td class="amount">{{ "{:,.0f}".format(item.amount) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% endfor %}
                                <tr class="total-row major-total">
                                    <td>純資産合計</td>
                                    <td class="amount">{{ "{:,.0f}".format(equity.get('total', 0)) }}</td>
                                </tr>
                                
                                <tr class="total-row major-total">
                                    <td>負債・純資産合計</td>
                                    <td class="amount">{{ "{:,.0f}".format(liabilities.get('total', 0) + equity.get('total', 0)) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </div>
    <div class="card-footer">
        <a href="{{ url_for('company.data_upload_wizard') }}" class="btn btn-primary">次のステップへ</a>
    </div>
</div>
{% endblock %}
