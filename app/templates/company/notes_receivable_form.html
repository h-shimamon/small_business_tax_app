{% extends "base.html" %}
{% from 'company/_form_helpers.html' import render_field, render_date_field %}

{# ページのタイトルを設定 #}
{% block title %}{{ form_title }} - 勘定科目内訳書{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/statement_of_accounts.css') }}">
{% endblock %}

{# 古いform_view.cssは不要になったので削除 #}

{# サイドバーは勘定科目内訳書画面と同じものを表示 #}
{% block sidebar %}
    {% set statement_pages = [
        ('deposits', '預貯金等'), ('notes_receivable', '受取手形'), ('accounts_receivable', '売掛金（未収入金）'),
        ('temporary_payments', '仮払金（前渡金）'), ('loans_receivable', '貸付金・受取利息'), ('inventories', '棚卸資産'),
        ('securities', '有価証券'), ('fixed_assets', '固定資産（土地等）'), ('notes_payable', '支払手形'),
        ('accounts_payable', '買掛金（未払金・未払費用）'), ('temporary_receipts', '仮受金（前受金・預り金）'), ('borrowings', '借入金及び支払利子'),
        ('sales_by_office', '事業所別売上高等'), ('executive_compensation', '役員給与等'), ('land_rent', '地代家賃等'),
        ('miscellaneous', '雑益・雑損失等')
    ] %}
    <h3 class="sidebar-title">勘定科目内訳書</h3>
    <ul class="sidebar-menu">
        {% for page_id, page_name in statement_pages %}
            <li>
                <a href="{{ url_for('company.statement_of_accounts', page=page_id) }}" 
                   class="sidebar-link {% if page_id == 'notes_receivable' %}active{% endif %}">
                    {{ page_name }}
                </a>
            </li>
        {% endfor %}
    </ul>
{% endblock %}

{# メインコンテンツ部分を定義 #}
{% block content %}
<div class="content-header">
    <h1 class="content-title">{{ form_title }}</h1>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="">
            {{ form.hidden_tag() }}

            {{ render_field(form.drawer, placeholder="例：株式会社 〇〇商事") }}
            {{ render_field(form.registration_number, placeholder="例：1234567890123") }}
            {{ render_date_field(form.issue_date) }}
            {{ render_date_field(form.due_date) }}
            {{ render_field(form.payer_bank, placeholder="例：〇〇銀行") }}
            {{ render_field(form.payer_branch, placeholder="例：本店") }}
            {{ render_field(form.amount, type="number", placeholder="例：1000000") }}
            {{ render_field(form.discount_bank, placeholder="（割引した場合）") }}
            {{ render_field(form.discount_branch, placeholder="（割引した場合）") }}
            {{ render_field(form.remarks, rows="3", placeholder="例：売掛金の回収分") }}

            <div class="form-actions">
                {{ form.submit(class="button-primary") }}
                <a href="{{ url_for('company.statement_of_accounts', page='notes_receivable') }}" class="button-secondary">キャンセル</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (window.flatpickr) {
        function buildYearSelect(instance) {
          const cal = instance.calendarContainer;
          if (!cal) return;
          const currentMonth = cal.querySelector('.flatpickr-current-month');
          if (!currentMonth) return;
          // Avoid duplicate insertion if already built
          if (currentMonth.querySelector('.nr-year-select') || currentMonth.querySelector('.nr-year-expand')) return;
          const yearInputWrapper = currentMonth.querySelector('.numInputWrapper');
          const yearInput = currentMonth.querySelector('input.cur-year');
          if (!yearInputWrapper || !yearInput) return;
          const select = document.createElement('select');
          select.className = 'nr-year-select';
          const curY = instance.currentYear || new Date().getFullYear();
          // initial window: show ±10 years around current (inclusive)
          const baseMin = curY - 10;
          const baseMax = curY + 10;
          const cfgMin = instance.config.minDate ? instance.config.minDate.getFullYear() : null;
          const cfgMax = instance.config.maxDate ? instance.config.maxDate.getFullYear() : null;
          const baseMin = curY - 10;
          const baseMax = curY + 10;
          const cfgMin = instance.config.minDate ? instance.config.minDate.getFullYear() : null;
          const cfgMax = instance.config.maxDate ? instance.config.maxDate.getFullYear() : null;
          const minY = cfgMin !== null ? Math.max(baseMin, cfgMin) : baseMin;
          const maxY = cfgMax !== null ? Math.min(baseMax, cfgMax) : baseMax;
          for (let y = maxY; y >= minY; y--) {
            const opt = document.createElement('option');
            opt.value = String(y);
            opt.textContent = y + '年';
            if (y === curY) opt.selected = true;
            select.appendChild(opt);
          }
          // caret button to reveal older years in 10-year chunks
          const expandBtn = document.createElement('button');
          expandBtn.type = 'button';
          expandBtn.className = 'nr-year-expand';
          expandBtn.title = '過去の年を表示';
          expandBtn.textContent = '＾';
          expandBtn.addEventListener('click', function() {
            const years = Array.from(select.options).map(o => parseInt(o.value, 10)).filter(n => !Number.isNaN(n));
            if (!years.length) return;
            const currentMin = Math.min.apply(null, years);
            const cfgMinYear = cfgMin;
            let added = 0;
            for (let y = currentMin - 1; y >= currentMin - 10; y--) {
              if (cfgMinYear !== null && y < cfgMinYear) break;
              const opt = document.createElement('option');
              opt.value = String(y);
              opt.textContent = y + '年';
              select.appendChild(opt);
              added++;
            }
            if (added === 0) expandBtn.disabled = true;
          });
          select.addEventListener('change', function() {
            const y = parseInt(this.value, 10);
            if (typeof instance.jumpToDate === 'function') {
              instance.jumpToDate(new Date(y, instance.currentMonth, 1));
            } else if (typeof instance.changeYear === 'function') {
              instance.changeYear(y);
              if (instance && typeof instance.redraw === 'function') { instance.redraw(); }
            }
          });
          // Hide native year input
          yearInputWrapper.style.display = 'none';
          currentMonth.querySelectorAll('.cur-year').forEach(function(el){ el.style.display = 'none'; });
          // Insert select and expand button before native input
          currentMonth.insertBefore(select, yearInputWrapper);
          currentMonth.insertBefore(expandBtn, yearInputWrapper);
        }

        const opts = {
          wrap: true,
          dateFormat: 'Y-m-d',
          altInput: true,
          altFormat: 'Y年m月d日',
          locale: flatpickr.l10ns.ja,
          monthSelectorType: 'dropdown',
          weekNumbers: true,
          disableMobile: true,
          allowInput: true,
          onReady: function(selectedDates, dateStr, instance) { buildYearSelect(instance); },
          onOpen: function(selectedDates, dateStr, instance) { buildYearSelect(instance); },
          onYearChange: function(selectedDates, dateStr, instance) {
            const btn = instance.calendarContainer && instance.calendarContainer.querySelector('.nr-year-button');
            if (btn) btn.textContent = String(instance.currentYear) + '年';
          }
        };
        document.querySelectorAll('.nr-date-picker').forEach(function(el){
          flatpickr(el, opts);
        });
      }
    });
  </script>
  <style>
    .nr-date-picker { position: relative; }
    .nr-date-picker .calendar-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color: #666; cursor: pointer; padding: 4px; display: flex; align-items: center; }
    .nr-date-picker .form-control { padding-left: 36px; }
    /* Ensure native year input in header is hidden to prevent duplicate year display */
    .flatpickr-current-month .numInputWrapper,
    .flatpickr-current-month input.cur-year,
    .flatpickr-current-month .cur-year { display: none !important; }
    /* Keep month header area usable */
    .flatpickr-months { overflow: visible !important; }
    .flatpickr-current-month { position: relative; z-index: 6; }

    .flatpickr-current-month .nr-year-select {
      margin-left: 6px;
      height: 28px;
      font-size: 14px;
      font-family: inherit;
      color: inherit;
      background: transparent;
      border: none;
    }
    .flatpickr-current-month .nr-year-expand {
      margin-left: 4px;
      height: 28px;
      line-height: 28px;
      font-size: 14px;
      font-family: inherit;
      color: inherit;
      background: transparent;
      border: none;
      cursor: pointer;
    }
  </style>
{% endblock %}
