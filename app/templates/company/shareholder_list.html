{% extends "base.html" %}
{% from 'company/_layout_helpers.html' import render_page_header %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/shareholder_list.css') }}">
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block sidebar %}
    {% include 'company/_wizard_sidebar.html' %}
{% endblock %}

{% block content %}
{{ render_page_header(
    title=page_title,
    subtitle='登録内容から自動で同族会社の判定を行うため、' ~ page_title ~ ' の作成は必須です。',
    button_href=url_for('company.register_main_shareholder'),
    button_text='新規グループ登録',
    secondary_href=(url_for('company.shareholders_pdf_beppyou_02', year='2025') if (shareholders|selectattr('parent_id', 'none')|list)|length > 0 else None),
    secondary_text='PDF出力（別表二）',
    secondary_first=True
) }}

{% set main_shareholders = shareholders|selectattr('parent_id', 'none')|list %}

{% if main_shareholders %}
    <div class="card classification-card">
        <h2 class="classification-title">同族会社の判定結果</h2>
        {% if classification_result and classification_result.classification %}
            {% set result = classification_result %}
            {% if result.classification == '同族会社' %}
                <p class="classification-text">
                    貴社は<strong>「同族会社」</strong>に該当します。
                </p>
                <div class="classification-details warning">
                    資本金が1億円以下の会社でも大法人（資本金5億円以上）の100％子会社等に該当する場合は、このアプリで対応できませんのでご注意ください。
                </div>
            {% else %}
                <p class="classification-text">
                    貴社は<strong>「非同族会社」</strong>に該当します。
                </p>
                <div class="classification-details">
                    (上位3グループの議決権割合: {{ result.top_three_percentage }}%)
                </div>
            {% endif %}
        {% else %}
            <p class="classification-text">株主情報が未登録のため、まだ判定できません。</p>
        {% endif %}
    </div>

    <div class="accordion-list">
        {% for main_shareholder in main_shareholders %}
        <div class="accordion-item">
            <div class="accordion-header">
                <div class="accordion-title">
                    <span class="main-name">{{ main_shareholder.last_name or '' }}</span>
                    <span class="main-role">(主たる株主)</span>
                    <span class="main-address">{{ main_shareholder.prefecture_city or '' }}{{ main_shareholder.address or '' }}</span>
                </div>
                <div class="accordion-summary">
                    {% if page_title == '社員情報' %}
                        <div class="summary-row">
                            <span>出資金: {{ (main_shareholder.investment_amount or 0) | money }}</span>
                        </div>
                    {% else %}
                        {# 1行目: グループ合計（主＋特殊関係人） #}
                        {% set totals = group_totals_both_map.get(main_shareholder.id) %}
                        <div class="summary-row">
                            <span>関係人を含めた総株式数: {{ (totals['shares_held'] if totals is not none else 0) | int }}株</span>
                            <span>関係人を含めた総議決権: {{ (totals['voting_rights'] if totals is not none else 0) | int }}</span>
                        </div>
                        {# 2行目: 主たる株主本人の内訳 #}
                        <div class="summary-row">
                            <span>株式数: {{ main_shareholder.shares_held or 0 }}株</span>
                            <span>議決権: {{ main_shareholder.voting_rights or 0 }}</span>
                        </div>
                    {% endif %}
                </div>
                <div class="accordion-actions">
                                        <a href="{{ url_for('company.edit_shareholder', shareholder_id=main_shareholder.id) }}" class="action-icon" title="編集"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></a>
                    
                    <form action="{{ url_for('company.delete_shareholder', shareholder_id=main_shareholder.id) }}" method="post" onsubmit="return confirm('この株主グループ全体が削除されます。本当によろしいですか？');">
                        <button type="submit" class="action-icon" title="削除"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                    </form>
                    <span class="accordion-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></span>
                </div>
            </div>
            <div class="accordion-content">
                {% if main_shareholder.children %}
                    {% for related in main_shareholder.children %}
                    <div class="related-row">
                        <div class="related-info">
                            <div>
                                <span class="related-name">{{ related.last_name or '' }}</span>
                                <span class="related-relationship">({{ related.relationship or '関係未設定' }})</span>
                            </div>
                            <span class="related-address">{{ related.prefecture_city or '' }}{{ related.address or '' }}</span>
                        </div>
                        <div class="related-summary">
                            {% if page_title == '社員情報' %}
                                <span>出資金: {{ (related.investment_amount or 0) | money }}</span>
                            {% else %}
                                <span>株式数: {{ related.shares_held or 0 }}株</span>
                                <span>議決権: {{ related.voting_rights or 0 }}</span>
                            {% endif %}
                        </div>
                        <div class="related-actions">
                            <a href="{{ url_for('company.edit_shareholder', shareholder_id=related.id) }}" class="action-icon" title="編集"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></a>
                            <form action="{{ url_for('company.delete_shareholder', shareholder_id=related.id) }}" method="post" onsubmit="return confirm('本当にこの情報を削除しますか？');">
                                <button type="submit" class="action-icon" title="削除"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <p class="no-related">登録されている特殊関係人はいません。</p>
                {% endif %}
                <div class="related-row add-new-row">
                    <a href="{{ url_for('company.register_related_shareholder', main_shareholder_id=main_shareholder.id) }}" class="add-new-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        <span>特殊関係人を追加登録する</span>
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <h2>まだ{{ page_title }}が登録されていません</h2>
        <p>最初の{{ page_title }}情報を登録しましょう。</p>
        <a href="{{ url_for('company.register_main_shareholder') }}" class="button-primary">＋ 新規登録</a>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', (event) => {
            // アクションアイコンやフォームのクリックはアコーディオンを開閉させない
            if (event.target.closest('.accordion-actions a, .accordion-actions button')) {
                return;
            }
            const item = header.parentElement;
            item.classList.toggle('open');
            // 開閉後にレイアウトが変わるため再計測
            requestAnimationFrame(computeDimensions);
        });
    });

    // ヘッダ情報カラム幅・サマリー左列幅・サマリー全体幅を算出し、CSS変数で共有
    function computeDimensions() {
        document.querySelectorAll('.accordion-item').forEach(item => {
            const titleEl = item.querySelector('.accordion-header .accordion-title');
            const sumRows = item.querySelectorAll('.accordion-header .accordion-summary .summary-row');
            if (!titleEl) return;
            const infoWidth = Math.ceil(titleEl.getBoundingClientRect().width);
            if (infoWidth > 0) {
                item.style.setProperty('--info-col-width', infoWidth + 'px');
            }
            let maxFirstCol = 0;
            let maxRowTotal = 0;
            let columnGapPx = 24; // デフォルト（1.5rem ≒ 24px）
            const summaryEl = item.querySelector('.accordion-header .accordion-summary');
            if (summaryEl) {
                const cs = getComputedStyle(summaryEl);
                const gap = parseFloat(cs.columnGap || '24');
                if (!isNaN(gap)) columnGapPx = gap;
            }
            sumRows.forEach(row => {
                const firstSpan = row.querySelector('span:first-child');
                const secondSpan = row.querySelector('span:nth-child(2)');
                const w1 = firstSpan ? Math.ceil(firstSpan.getBoundingClientRect().width) : 0;
                const w2 = secondSpan ? Math.ceil(secondSpan.getBoundingClientRect().width) : 0;
                maxFirstCol = Math.max(maxFirstCol, w1);
                maxRowTotal = Math.max(maxRowTotal, w1 + columnGapPx + w2);
            });
            if (maxFirstCol > 0) {
                item.style.setProperty('--summary-first-col', maxFirstCol + 'px');
            }
            if (maxRowTotal > 0) {
                item.style.setProperty('--summary-col-width', maxRowTotal + 'px');
            }
        });
    }
    computeDimensions();
    window.addEventListener('resize', computeDimensions);
});
</script>
{% endblock %}
