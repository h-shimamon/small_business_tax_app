{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/upload_data.css') }}">
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title-text">{{ title }}</h1>
        <p class="card-subtitle-text">{{ description }}</p>
    </div>
    <div class="card-body">
        <div class="upload-container" x-data="uploadComponent('{{ session.get('selected_software', 'other') }}')">
            
            <div class="export-guide">
                <h3 x-text="guide.title"></h3>
                <ol>
                    <template x-for="instruction in guide.steps" :key="instruction">
                        <li x-text="instruction"></li>
                    </template>
                </ol>
            </div>

            <div class="upload-area-wrapper">
                <form method="POST" enctype="multipart/form-data" novalidate>
                    {{ form.hidden_tag() }}
                    <div class="upload-area" 
                         @dragover.prevent="dragover = true" 
                         @dragleave.prevent="dragover = false" 
                         @drop.prevent="handleDrop($event)" 
                         @click="$refs.fileInput.click()"
                         :class="{'dragover': dragover, 'is-invalid': {{ 'true' if form.upload_file.errors else 'false' }} }">
                        
                        {{ form.upload_file(class="file-input", **{"x-ref": "fileInput", "@change": "handleFileSelect($event)", "accept": ".csv,.txt"}) }}
                        
                        <div x-show="!fileName">
                            <div class="upload-icon">☁️</div>
                            <p>ここにファイルをドラッグ＆ドロップ</p>
                            <p>または<a href="#" @click.prevent class="browse-link">ファイルを選択</a></p>
                        </div>
                        <div x-show="fileName">
                            <p>選択されたファイル: <strong x-text="fileName"></strong></p>
                        </div>
                    </div>
                    
                    {% if form.upload_file.errors %}
                        <div class="invalid-feedback d-block mt-2">
                            {% for error in form.upload_file.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="form-actions">
                        {{ form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
            </div>

            {% if show_reset_link %}
            <div class="reset-link-container">
                <a href="{{ url_for('company.reset_account_mappings_confirmation') }}">勘定科目データの再アップロード（マッピング情報がリセットされます）</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    function uploadComponent(selectedSoftware) {
        return {
            dragover: false,
            fileName: null,
            guide: {},
            guides: {
                yayoi: {
                    title: '弥生会計からのデータエクスポート手順',
                    steps: [
                        '「ファイル」メニューから「エクスポート」を選択します。',
                        '「仕訳日記帳」などを選択し、CSV形式で出力します。',
                        '文字コードは「Windows-31J (Shift_JIS)」を選択してください。'
                    ]
                },
                freee: {
                    title: 'freeeからのデータエクスポート手順',
                    steps: [
                        '「決算」または「レポート」メニューから「仕訳帳」などを選択します。',
                        '「エクスポート」機能で「汎用形式」のCSVをダウンロードします。',
                        '対象期間などを正しく設定してください。'
                    ]
                },
                moneyforward: {
                    title: 'マネーフォワード クラウドからのデータエクスポート手順',
                    steps: [
                        '「会計帳簿」から「仕訳帳」を選択します。',
                        '画面右上の「エクスポート」からCSVファイルをダウンロードします。',
                        '必要な期間と形式を選択してください。'
                    ]
                },
                other: {
                    title: '一般的なCSVファイルのエクスポート手順',
                    steps: [
                        'お使いの会計ソフトからCSV形式でデータを出力してください。',
                        '文字コードは「UTF-8」または「Shift-JIS」を推奨します。'
                    ]
                }
            },
            init() {
                this.guide = this.guides[selectedSoftware] || this.guides['other'];
                const initialFile = this.$refs.fileInput.files[0];
                if (initialFile) {
                    this.fileName = initialFile.name;
                }
            },
            handleDrop(event) {
                this.dragover = false;
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    this.$refs.fileInput.files = files;
                    this.fileName = files[0].name;
                }
            },
            handleFileSelect(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    this.fileName = files[0].name;
                } else {
                    this.fileName = null;
                }
            }
        }
    }
    </script>
{% endblock %}
