# マイグレーション運用ガイドライン

本プロジェクトで Alembic マイグレーションを追加・修正する際の手順とルールを整理します。

## 基本原則

- **単一履歴を維持する**: `down_revision` で参照されるリビジョンは必ずリポジトリ内に存在させ、欠番を作らない。
- **ドキュメント化されたマイグレーション**: 各マイグレーションファイルのモジュール docstring で変更内容を簡潔に説明する。
- **雛形の活用**: `alembic revision -m "..."` を実行すると `migrations/script.py.mako` のテンプレートが適用される。必要に応じて docstring を編集して目的・背景・ロールバック戦略を追記する。
- **生成物の検証**: `scripts/check_migrations.py` を使ってローカルでも欠番・docstring チェックを実行し、CI での失敗を防ぐ。

## 推奨ワークフロー

1. スキーマ変更を整理し、影響範囲・ロールバック方針を決める。
2. `alembic revision -m "<短い説明>"` を実行し、新しいマイグレーションファイルを生成する。
3. 生成されたファイルの docstring を編集し、以下の観点を含める（例）:
   - 概要: 何を変更するのか
   - 理由: 背景や依存するチケット
   - Rollback: ダウングレード時の注意点
4. スキーマ変更内容を `upgrade()` / `downgrade()` に実装する。
5. `python scripts/check_migrations.py` を実行し、欠番や docstring がチェックを通過することを確認する。
6. プロジェクトのテスト (`pytest`) を実行する。
7. コードレビュー時には、本ガイドラインへの準拠と生成スクリプトの実行結果を共有する。

## CI チェックについて

- GitHub Actions (`.github/workflows/ci.yml`) では `scripts/check_migrations.py` を自動で実行します。
- 失敗した場合はログに不足している情報が出力されるので、指摘を解消してから再実行してください。

---
このガイドラインは必要に応じて拡張・更新してください。改善案があれば Issue / PR で共有をお願いします。