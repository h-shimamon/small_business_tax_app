# 税計算仕様 v0

## 前提
- 対象期間は `TaxPeriod` として開始日・終了日・月数（端数切り上げ）・端数月数（特例計算用）を保持。
- マスタ税率は `CorporateTaxMaster` を起点としてドメイン層 `TaxRates`/`EqualizationAmounts` に変換する。
- 入出力は辞書互換の `TaxCalculation.to_payload()` を経由し、既存UIと後方互換。

## 計算順序
1. **課税所得の確定**
   - 別表4の加減算（`bridges.bepyo4.derive_taxable_income`）で課税所得を算出。
   - 零未満の場合は 0 に補正。
2. **法人税（国税）**
   - 月数換算した 800 万円上限で低税率・高税率に分割。
   - 端数処理: 千円未満は `ceil`/`floor` で、最終税額は 100 円未満切捨て。
3. **事業税（外形標準課税）**
   - 4 百万円刻みの区分（〜4M, 4–8M, 8M超）を月数補正。
   - それぞれ千円未満切捨て・税額は 100 円未満切捨て。
4. **地方法人税・地方税**
   - 地方法人税は法人税額（100円未満切捨て後）×税率。
   - 県民税・市民税は法人税額を千円未満切捨てした基準額を使用。
   - 均等割は月数按分後に 100 円未満切捨て。
5. **地方特別法人税（地方法人特別税）**
   - 事業税額合計 × 税率を 100 円未満切捨て。

## 端数処理
| 区分 | 処理 | 備考 |
| --- | --- | --- |
| 課税所得分割 | 千円未満切上/切下 | 800 万円・4 百万円基準 |
| 税額 | 円単位四捨五入（ROUND_HALF_UP）後に 100 円未満切捨て | `TaxComponents` に保持 |
| 均等割 | 12 分割後 100 円未満切捨て | 月数端数は切上済み |

## テスト方針
- 単年度のゴールデンケース（資本金 1 億円以下・課税所得 1,200 万円）で既存UI値と完全一致。
- パラメータ化による境界値（0 円、800 万円、4 百万円等）を `tests/test_corporate_tax_service.py` に追加。
- `TaxEngine` はドメイン直結テストで I/O の純粋性を保証。

## 今後の連携
- 別表5(1)(2) の集計結果は `bridges.bepyo5` を通じて `TaxInput` に情報を補足予定。
- 各別表テンプレートは `TaxBreakdown` を受け取り、PDF/プレビュー用に再編成する。