# リファクタリング追随メモ（フォローアップ）

更新日: 2025-08-25

- 項目: SoAカードのアクションUI統一に伴う未使用マクロの扱い
  - 現状: `app/templates/company/_components_item_actions.html` の `item_actions_menu` は未使用（全カードをアイコン形式に統一済み）。
  - アクション（設定画面実装時）:
    - 設定（UIポリシー）で「カードのアクションUI形式（アイコン/メニュー）」を切り替える要件が出た場合:
      - `_card_base.html` に分岐復帰 or 設定値に応じた切替実装を提案。
    - 逆に設定側で切替ニーズがない場合:
      - `item_actions_menu` と関連CSS/JSの削除を提案（デッドコード整理）。
  - トリガー: 設定画面（Settings/Master）初期実装完了時点で再提案。
  - 目的: 指示ミスの防止と保守性向上（不要コードの削減、または柔軟性の集中管理）。


- 項目: 日付カラム命名統一（Company／NotesReceivable）
  - 現状: Date型とString(10)型の重複カラムが共存し、`*_date_date` のような冗長命名が残存。フォーム／PDF／CLIが旧文字列名を参照しており、DB側のDate列と二重管理になっている。
  - 段階計画:
    1. 命名整理: Alembicで `closing_date_date` → `closing_date`（Date）など冗長接尾辞を整理し、`NotesReceivable` の Date 列を正式カラムへ昇格。
    2. マイグレーション設計: 文字列列から Date 列へ `COALESCE(parse(old), new)` でバックフィルしつつ旧列をビュー経由に切替。アプリ切替後に旧列を安全に削除。
    3. アプリ側対応: フォーム／PDF／CLI／シード／`ensure_date` 利用箇所を Date 前提に書き換え、互換プロパティは最小限に限定。
    4. 検証とリリース: `tests/test_statement_of_accounts_service_defaults.py` などに日付整合テストを追加し、社内→本番の2段階デプロイでデータ整合を確認後、旧列削除マイグレーションを適用。
  - 次手: 計画内容をプロジェクトレビューに提出し、承認後に Alembic スクリプトとアプリ差分を着手。

- 項目: Shareholderモデル拡張構想
  - 現状: 単一テーブルに個人・法人・自社を同居させており、`entity_type` で分岐しながら個人専用カラム（relationship など）と法人向けカラム（is_controlled_company など）が混在。新規属性を追加するたびに列が増え、フォームやPDFの条件分岐が散在している。
  - アプローチ比較:
    1. タイプ別詳細テーブル方式（推奨）: `shareholder` は共通情報のみ保持し、`shareholder_corporate_detail`・`shareholder_individual_detail` などの1対1テーブルで属性を拡張。SQL 制約と型安全性を確保でき、将来の列追加も各テーブルに閉じる。ORM レベルで `joinedload` すれば既存サービスの大半は影響を受けず、型別フォームへのマッピングも明瞭。
    2. `extra_attributes` JSONB 方式: 柔軟だがバリデーションとマイグレーション管理がコード側に寄り、検索/集計で JSON 演算子依存となる。軽微な拡張には便利だが、税務帳票で厳密な型が要求されるケースでは運用コストが高い。
  - 推奨方針: タイプ別詳細テーブル方式。共通テーブルは `entity_type` とキー情報を維持しつつ、詳細は SQL レベルで必須/任意を分離。既存カラムは段階的に詳細テーブルへ移行し、互換用プロパティ（`Shareholder.corporate_detail.tax_id` など）をサービス層で参照する。
  - 実施手順（ドラフト）:
    1. スキーマ設計: 詳細テーブルごとの列定義とリレーションを設計し、Alembic マイグレーション（新テーブル作成＋既存カラムのコピー）を用意。
    2. アプリ更新: ShareholderService とフォームをリファクタし、タイプ別に `populate_obj` で詳細テーブルへ保存。PDF/CSV 生成コードは共通アクセサ経由で取得。
    3. データ移行: マイグレーションで既存値を各詳細テーブルへバックフィルし、旧カラムを読み取り専用に切替。移行完了後に旧カラムを段階的に削除。
    4. テスト: サービス層・フォーム・帳票の回帰テストを追加し、タイプ別ケース（個人/法人/自社）を網羅。
  - 次手: 詳細テーブルの属性要件（法人番号、役職肩書き、続柄など）を事業側と確定し、マイグレーション草案とサービス更新計画をスプリント計画に追加。
