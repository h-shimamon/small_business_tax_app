# 本日のE2Eテストまとめ（2025-08-21）

## 概要
- 目的: 既存Flaskアプリに対して非破壊のE2Eテスト（Playwright）を整備し、ハッピーパス/ファズ/モンキー/壊れファイルを網羅的に実行可能にする。
- 結果: テスト基盤の追加・初期実行は完了。ただし初回実行はアプリ未起動により接続拒否で全テスト失敗。アプリを5002で起動後は未再実行（ログイン画面テンプレ有無の確認が未完）。

## 本日実施
- ドキュメント作成:
  - `temporary/要件定義書.md`, `temporary/基本設計書.md` 作成（仕様確認用）
- E2E基盤追加（アプリ本体は未改変）:
  - `package.json`, `tsconfig.json`, `playwright.config.ts`
  - `tests/e2e/` にテスト一式（ハッピーパス/モンキー/入力ファズ/状態遷移/壊れファイル）
  - `tests/fixtures/` に簡易ダミー（`freee_sample.json`, `bad.csv`）
- テスト用アカウント作成（DB書込み）:
  - ユーザー: `e2e_user / e2e_password_123`
  - 紐付会社を自動作成（テスト用ダミー会社）
- マスター同期:
  - Flask CLI `seed-masters` 実行済み
- 初回E2E実行（失敗）:
  - 失敗理由: `ERR_CONNECTION_REFUSED`（`http://localhost:5001` でアプリ未起動）
  - 失敗時のトレース/動画/スクショは `test-results/` に保存
- アプリ再起動（手元ログ）:
  - `FLASK_APP=run.py flask run -h 0.0.0.0 -p 5002`
  - ただしE2Eの再実行は未実施（ログイン画面テンプレ有無の確認保留）

## 失敗点 / 現象（初回）
- すべてのテストで `page.goto('/company/...')` が `ERR_CONNECTION_REFUSED` で失敗
- Playwrightのレポート/トレース/動画は生成済み（接続直後に失敗）

## 原因の仮説
1) アプリ未起動（事実）→ 接続拒否
2) ログイン画面テンプレート `app/templates/login.html` が欠落している可能性（ログイン時500の可能性）
3) 画面ラベル/要素セレクタ差異により一部テストのセレクタ調整が必要
4) ハッピーパスで「SoA差異=0」を確認するには、実データに近いCSV/SoA入力の準備が必要

## 現在のテスト環境
- BASE_URL 既定: `http://localhost:5001`（configで変更可）
- 推奨（本日）: `http://127.0.0.1:5002`（5002で起動中）
- トレース/動画/スクショ: 失敗時 or リトライ時に自動保存
- レポート: `playwright-report/` からHTMLで確認可能

## 次回の実行手順
1) サーバ起動
   - `python run.py`（5001が空いていれば）または
   - `FLASK_APP=run.py flask run -h 0.0.0.0 -p 5002`
2) ログイン動作の事前確認
   - `http://127.0.0.1:5002/company/login`
   - テスト用: ユーザー名 `e2e_user`, パスワード `e2e_password_123`
   - 500 が出る場合: `app/templates/login.html` の最小テンプレ追加（ロジックは未変更）
3) E2E実行
   - `BASE_URL=http://127.0.0.1:5002 TEST_USERNAME=e2e_user TEST_PASSWORD=e2e_password_123 npm run test:e2e`
   - レポート: `npm run test:e2e:report`
4) 失敗時の再現
   - `npx playwright show-trace test-results/**/trace.zip`

## 次回の着手ポイント（優先度順）
1) ログイン画面テンプレの有無確認（無ければ最小テンプレ追加）
2) 主要フォームのラベル/セレクタ確認（`getByLabel`, `getByRole` で取りやすいか）
3) ハッピーパス用の最小CSV（MoneyForward形式）の用意
   - 期首/期中の分離ロジックに合う列・データ型
   - SoA差異0を作れるように、SoA側の入力 or 0残高自動スキップの検証データ
4) ファイルアップロードのname属性/受け付け拡張子の確認（CSV/TXT）
5) PDF出力ルートの動作確認（直接send_fileか、ボタン押下ダウンロードか）

## コマンド覚書
- 依存導入: `npm install` / `npx playwright install --with-deps`
- 実行: `BASE_URL=... TEST_USERNAME=... TEST_PASSWORD=... npm run test:e2e`
- レポート: `npm run test:e2e:report`
- トレース閲覧: `npx playwright show-trace test-results/**/trace.zip`

## 追加/変更ファイル一覧（テスト関連）
- ルート:
  - `package.json`, `tsconfig.json`, `playwright.config.ts`
- テスト:
  - `tests/e2e/00_login.spec.ts`
  - `tests/e2e/01_happy_path.spec.ts`
  - `tests/e2e/02_monkey_gremlins.spec.ts`
  - `tests/e2e/03_property_based_inputs.spec.ts`
  - `tests/e2e/04_state_transitions.spec.ts`
  - `tests/e2e/05_broken_uploads.spec.ts`
  - `tests/e2e/utils.ts`
- フィクスチャ:
  - `tests/fixtures/freee_sample.json`, `tests/fixtures/bad.csv`
- `.gitignore` にNode/Playwright生成物を追記

## テスト用アカウント
- ユーザー名: `e2e_user`
- パスワード: `e2e_password_123`
- 紐付会社: 自動作成済み（Company 1:1）

## 生成物の場所
- HTMLレポート: `playwright-report/index.html`
- 失敗時の証跡: `test-results/`（trace.zip / video.webm / screenshot.png）

---
本書は「確認用メモ」です。明日以降、上記の優先度に沿って、ログイン画面の確認→セレクタ調整→最小CSV整備→ハッピーパス達成→ファズ/モンキー強化の順で進める想定です。

