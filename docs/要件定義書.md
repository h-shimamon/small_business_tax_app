# 要件定義書（ドラフト）

最終更新: 自動生成（現行コード解析に基づく）

## 1. 文書の目的
- 本システム（中小法人向け申告支援アプリ）の現行コードから読み取れる要件を網羅し、合意形成・詳細設計の基礎とする。
- 本書は現行実装を基にしたドラフトであり、未確定事項・既知の未実装は別途明記する。

## 2. 背景と目標
- 背景: 申告業務に必要な各種情報（会社情報、株主、事業所、申告情報）を管理し、会計ソフトのデータを取り込み、財務諸表（B/S・P/L）と勘定科目内訳書を整合的に作成・出力するニーズ。
- 目標:
  - 会計データ取込（CSV/TXT）→ 勘定科目マッピング → 財務諸表自動生成 → 内訳書入力・突合 → PDF帳票出力の一連のフローを提供。
  - 科目の不一致や未計上科目を検知し、必要ページを自動スキップまたは注意喚起することで作業負荷を低減。

## 3. スコープ
- 含む:
  - ログイン/ログアウト、会社基本情報、株主・社員（グルーピング）、事業所、申告情報の登録・更新
  - 会計ソフト選択、勘定科目ファイル取込、未マッピング科目の対応付け、仕訳帳取込、財務諸表（B/S・P/L）生成・保存
  - 勘定科目内訳書のページ別管理・合計・B/S/P/Lとの突合・完了管理・スキップ
  - PDF出力（別表二、預貯金内訳 等）
- 含まない（現時点）:
  - freee/弥生のCSV仕様への完全対応（雛形のみ）
  - 固定資産データ取込ロジック（ウィザード項目はあるが未実装）
  - ユーザーのサインアップ機能（ログインは実装済、ユーザー生成は別途）

## 4. 用語定義
- SoA: Statement of Accounts（勘定科目内訳書）
- マッピング: 会計ソフトの原科目名 → システムのマスター科目名への対応付け
- 期首・期中: 仕訳帳から期首残高に相当する取引と期中取引を分離（マネーフォワード仕様ベース）

## 5. 利用者・ロール
- ログインユーザー（1ユーザー = 1社が前提）
- 権限制御: 自社（ユーザーに紐づく会社）のデータのみ参照・更新可

## 6. 前提条件
- Webアプリ（Flask）。セッション・CSRF保護あり。DBは開発時SQLite、本番はRDBMS想定。
- 日本語UI/帳票、NotoSansJPフォント同梱。

## 7. 業務フロー（概要）
1) ログイン → 2) 会社情報登録 → 3) 株主/社員登録（グループ化） → 4) 申告情報登録
→ 5) 会計ソフト選択 → 6) 勘定科目取込 → 7) 未マッピング科目の対応付け
→ 8) 仕訳帳取込（マッピング適用・B/S・P/L生成保存） → 9) SoA各ページ入力・突合
→ 10) PDF出力・確認

## 8. 画面/URL 要件（主要）
- 認証: `/company/login`, `/company/logout`
- 会社情報: `/company/info`
- 株主/社員: `/company/shareholders`, `.../register/main`, `.../register/related/<id>`, `.../edit/<id>`, `.../delete/<id>`
- 事業所: `/company/offices`, `.../office/register`, `.../office/edit/<id>`, `.../office/delete/<id>`
- 申告情報: `/company/declaration`
- 取込ウィザード: `/company/select_software`, `/company/data_upload_wizard`, `/company/upload/<datatype>`, `/company/data_mapping`, リセット/管理系
- SoA: `/company/statement_of_accounts?page=<key>`, Add/Edit 汎用ルート
- PDF: `/company/shareholders/pdf/beppyou_02`, `/company/statement/deposits/pdf`

## 9. 機能要件（詳細）
### 9.1 認証/認可
- ログイン/ログアウトが可能。ログイン必須の画面保護。
- `company_required`で会社未登録時は会社情報ページへ誘導。

### 9.2 会社基本情報
- 法人番号・名称・住所・電話・設立日・業種等を登録/更新。

### 9.3 株主/社員管理
- 主たる株主（親）と特殊関係人（子）をグルーピング登録/編集/削除。
- 会社種別に応じ、議決権または出資金を指標に上位3グループの割合を算出し「同族/非同族」を表示。
- 別表二PDFを生成・表示（印刷可）。

### 9.4 事業所管理
- 事業所の登録/編集/削除、一覧表示。

### 9.5 申告情報
- 会計期間、申告区分、消費税経理方式、代表者/経理責任者/税理士、還付口座等を登録/更新。

### 9.6 会計データ取込ウィザード
- 会計ソフト選択（弥生/freee/マネフォ/その他）。
- 勘定科目ファイル取込 → マスターと照合 → 未マッピング科目を提示、ユーザー単位で対応付け保存。
- 仕訳帳取込（実装済: マネーフォワード）→ ユーザーのマッピング適用 → 期首/期中の分離 → 財務諸表（B/S・P/L）生成 → DB保存。
- マッピングの一覧・削除・一括リセット。（本人のもののみ）

### 9.7 勘定科目内訳書（SoA）
- 対象ページ: 預貯金、受取手形、売掛金、仮払金、貸付金、棚卸資産、有価証券、固定資産、支払手形、買掛金、仮受金、借入金・支払利子、役員給与、地代家賃、雑益/雑損失。
- 各ページで項目の登録/編集/削除、合計の表示。
- B/S（またはP/L）残高と内訳書合計の突合。差異が0ならステップ完了扱い。
- 該当残高が0のページは自動スキップ（サイドバー反映、順送り遷移）。

### 9.8 PDF出力
- 別表二、預貯金内訳をPDF生成しブラウザ表示（保存/印刷可能）。

## 10. 非機能要件
- 性能: 仕訳CSVは中小規模（数〜数十MB程度）で扱えること。インポート/集計は実用待ち時間内（目安: 数十秒以内）
- 可用性: Webアプリとして通常運用。DBバックアップ/復元手順は運用設計で補完。
- セキュリティ: セッション管理、CSRF、パスワードハッシュ、アクセス制御（user/companyスコープ）。
- 監視/ログ: 重要イベントと警告をログ出力（レベル設定可）。
- 言語/表示: 日本語UI、帳票は日本語フォント埋込で文字化けしないこと。

## 11. データ要件（主要エンティティ）
- User（認証）
- Company（会社＋申告情報、Userと1:1）
- Shareholder（親子自己参照、グループ）
- Office（事業所）
- AccountTitleMaster（勘定科目マスター: 種別、カテゴリ、内訳書対応、順序）
- UserAccountMapping（ユーザー別 原科目→マスター科目、(user_id, original)ユニーク）
- AccountingData（会計期間、B/S・P/LのJSON、最新版参照）
- SoA各種モデル（14種程度）

## 12. 外部I/F（ファイル）
- 入力: CSV/TXT、Shift_JIS優先自動判定、区切りはカンマ/タブ自動判定。
- 対応ソフト: マネーフォワード（実装済）、freee/弥生/その他（雛形）。
- 出力: PDF（テンプレート合成。`temporary/filled`に生成）。

## 13. 帳票要件
- 別表二: 上位3グループの比率と同族/非同族の明示。版面はテンプレート＋座標指定で文字配置。
- 預貯金内訳: 金融機関・支店・科目・口座・残高等を出力。

## 14. エラー/例外
- ファイルエンコーディング判定失敗、列不足、未マッピング有り、会計期間未設定、DB保存失敗等に対して画面通知（flash）。
- DBトランザクション失敗時はロールバック。

## 15. 受入基準（例示）
- 勘定科目取込後、未マッピングがなければウィザードが次工程に遷移すること。
- 仕訳帳取込後、B/SとP/Lが生成・保存され、SoAの自動スキップが有効になること。
- SoA各ページで B/S/P/L値と内訳合計が一致すると当該ステップが完了に変わること。
- 別表二・預貯金のPDFがブラウザ表示でき、主要フィールドが正しい位置で読めること。

## 16. 既知の未実装/制約
- freee/弥生パーサー: 雛形のみ。
- 固定資産データ取込: ロジック未実装。
- 会社/ユーザーの多対多や複数社管理は想定外（現状 1:1）。

## 17. リスク/課題/未確定事項
- 入力ファイルサイズ上限/タイムアウト等の運用値が未定義。
- 帳票テンプレートの年次更新ポリシー（版面差異吸収）が未確定。
- マスター更新手順の標準化（配布、バージョン固定、差分適用）。

## 18. 変更履歴
- 初版（自動生成）

